<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>仲裁工具 v1.0</title>
<script src="../taxonomy/visual_elements_global.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
<style>
/* ===== CSS VARIABLES - Obsidian Studio Royal Violet ===== */
:root {
  --bg: #0c0b10;
  --surface: #14131a;
  --surface2: #1c1b24;
  --surface3: #26253a;
  --text: #ece9e4;
  --text-dim: #7a7888;
  --accent: #a78bfa;
  --accent-hover: #c4b5fd;
  --accent-dim: rgba(167, 139, 250, 0.10);
  --accent-glow: rgba(167, 139, 250, 0.25);
  --green: #34d399;
  --red: #fb7185;
  --orange: #fbbf24;
  --yellow: #fde68a;
  --border: rgba(255,255,255,0.06);
  --border-accent: rgba(167, 139, 250, 0.20);
  --ai-bg: rgba(167, 139, 250, 0.06);
  --user-bg: rgba(167, 139, 250, 0.10);
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 24px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 48px rgba(0,0,0,0.5);
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 16px;
  --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

/* ===== CUSTOM SCROLLBAR ===== */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.15); }

body {
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  color-scheme: dark;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ===== TOP BAR - Frosted Glass ===== */
.top-bar {
  background: rgba(20, 19, 26, 0.85);
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  padding: 12px 24px;
  display: flex; align-items: center; gap: 20px;
  flex-wrap: wrap; min-height: 48px;
}
.top-bar .title {
  font-size: 15px; font-weight: 700; color: var(--accent);
  letter-spacing: -0.02em; white-space: nowrap;
}
.top-bar .controls { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
.top-bar label {
  font-size: 13px; color: var(--text-dim);
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
}
.top-bar select {
  background: var(--surface2); color: var(--text); border: 1px solid var(--border);
  color-scheme: dark;
  padding: 5px 10px; border-radius: var(--radius-sm); font-size: 13px;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  transition: var(--transition); cursor: pointer;
}
.top-bar select:focus {
  border-color: var(--accent); outline: none;
  box-shadow: 0 0 0 3px var(--accent-dim);
}

.top-bar select option {
  background: var(--surface2);
  color: var(--text);
}
.top-bar .progress-text { font-size: 13px; color: var(--text-dim); }
.top-bar .progress-text span { color: var(--accent); font-weight: 600; }

/* ===== TAXONOMY LINK ===== */
.taxonomy-link {
  font-size: 11px; background: rgba(20, 19, 26, 0.6);
  padding: 6px 24px; border-bottom: 1px solid var(--border);
}
.taxonomy-link a { color: var(--accent); font-weight: 500; text-decoration: none; }
.taxonomy-link a:hover { text-decoration: underline; color: var(--accent-hover); }

/* ===== MAIN CONTENT ===== */
.main-content { display: flex; flex: 1; overflow: hidden; }

.left-panel {
  flex: 1; display: flex; flex-direction: column;
  padding: 16px; border-right: 1px solid var(--border); min-width: 300px; overflow-y: auto;
}

/* ===== IMAGE SECTION ===== */
.image-section {
  position: relative;
  display: flex; align-items: center; justify-content: center;
  background: #08080c;
  border-radius: var(--radius-md);
  border: 1px solid var(--border);
  box-shadow: var(--shadow-md);
  overflow: hidden; min-height: 200px; max-height: 40vh; margin-bottom: 14px;
}
.image-section img { max-width: 100%; max-height: 40vh; object-fit: contain; }
.image-section .placeholder {
  color: var(--text-dim); font-size: 14px; text-align: center; padding: 40px;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
}
.image-loading {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
  display: none; flex-direction: column; align-items: center; gap: 12px; z-index: 2;
}
.image-loading.active { display: flex; }
.spinner {
  width: 36px; height: 36px; border: 3px solid var(--surface3);
  border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.image-loading span { font-size: 12px; color: var(--text-dim); }

/* ===== TASK INFO ===== */
.task-info {
  font-size: 13px; color: var(--text-dim); text-align: center; margin-bottom: 12px;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
}
.task-info .task-id {
  color: var(--accent); font-weight: 600; font-size: 15px;
  font-family: 'JetBrains Mono', monospace;
}

/* ===== HISTORY PANEL ===== */
.history-panel {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--radius-md); padding: 16px;
  flex: 1; overflow-y: auto;
}
.history-panel .panel-title {
  font-size: 12px; font-weight: 700; color: var(--accent);
  text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 12px;
}

/* ===== HISTORY GROUPS ===== */
.history-group {
  margin-bottom: 14px; padding-bottom: 12px;
  border-bottom: 1px solid rgba(255,255,255,0.04);
}
.history-group:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
.history-group .group-title {
  font-size: 11px; font-weight: 700; color: var(--text-dim);
  text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 8px;
}

/* ===== HISTORY ROWS ===== */
.history-row {
  display: flex; align-items: flex-start; gap: 8px; padding: 6px 10px;
  font-size: 12px; margin-bottom: 3px; border-left: 3px solid transparent;
  border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  transition: var(--transition);
}
.history-row:hover { background: rgba(255,255,255,0.02); }
.history-row .row-label {
  font-weight: 600; min-width: 50px; flex-shrink: 0; color: var(--text-dim);
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
}
.history-row .row-path {
  flex: 1; word-break: break-word;
  font-family: 'JetBrains Mono', monospace; font-size: 12px;
  line-height: 1.5;
}
.history-row .row-meta {
  font-size: 11px; padding: 2px 8px; border-radius: 10px; flex-shrink: 0;
  background: rgba(167, 139, 250, 0.08);
}
.history-row.agree { border-left-color: var(--green); }
.history-row.disagree { border-left-color: var(--red); }
.history-row.neutral { border-left-color: var(--text-dim); }

/* ===== RULES PANEL ===== */
.rules-panel {
  background: var(--accent-dim); border: 1px solid var(--border-accent);
  border-radius: var(--radius-md); padding: 14px; margin-top: 12px;
  max-height: 150px; overflow-y: auto;
  border-left: 3px solid var(--accent);
}
.rules-panel .panel-title {
  font-size: 11px; font-weight: 700; color: var(--accent);
  text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 8px;
}
.rules-panel .rule-text {
  font-size: 11px; color: var(--text-dim); line-height: 1.7;
  white-space: pre-wrap; word-break: break-word;
}

/* ===== RIGHT PANEL ===== */
.right-panel {
  width: 480px; min-width: 400px; display: flex; flex-direction: column;
  padding: 16px; overflow-y: auto; gap: 12px;
}

/* ===== DECISION SECTION ===== */
.decision-section { display: flex; flex-direction: column; gap: 6px; }
.decision-section .section-title {
  font-size: 13px; font-weight: 700; color: var(--accent); margin-bottom: 4px;
  letter-spacing: -0.01em;
}

/* ===== DECISION OPTIONS ===== */
.decision-options { display: flex; flex-wrap: wrap; gap: 6px; }
.decision-options label {
  display: flex; align-items: center; gap: 8px; padding: 8px 16px;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--radius-sm); cursor: pointer; font-size: 13px;
  transition: var(--transition);
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  word-break: break-word; line-height: 1.5;
}
.decision-options label:hover {
  border-color: var(--accent); transform: translateY(-1px);
}
.decision-options label.selected {
  border-color: var(--accent); background: var(--accent-dim);
  box-shadow: 0 0 0 1px var(--accent);
}
.decision-options input[type="radio"] { accent-color: var(--accent); }

/* ===== LEVEL SELECTORS ===== */
.selector-section { display: flex; flex-direction: column; gap: 6px; }
.level-row { display: flex; align-items: center; gap: 8px; }
.level-label {
  width: 28px; font-size: 12px; font-weight: 700; color: var(--accent); flex-shrink: 0;
  font-family: 'JetBrains Mono', monospace;
}
.level-select-wrapper { flex: 1; }
.level-select-wrapper select {
  width: 100%; background: var(--surface2); color: var(--text);
  color-scheme: dark;
  border: 1px solid var(--border); padding: 8px 12px;
  border-radius: var(--radius-sm); font-size: 13px;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  cursor: pointer; transition: var(--transition);
}
.level-select-wrapper select:disabled { opacity: 0.35; cursor: not-allowed; }
.level-select-wrapper select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-dim);
  outline: none;
}
.level-select-wrapper select.user-selected {
  border-color: var(--accent); background: var(--accent-dim);
}

.level-select-wrapper select option {
  background: var(--surface2);
  color: var(--text);
}

.level-search { position: relative; flex: 1; display: none; }
.level-search input {
  width: 100%; background: var(--surface2); color: var(--text); border: 1px solid var(--border);
  padding: 7px 10px; border-radius: var(--radius-sm); font-size: 12px;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  transition: var(--transition);
}
.level-search input:focus {
  border-color: var(--accent); outline: none;
  box-shadow: 0 0 0 3px var(--accent-dim);
}
.level-search .search-results {
  position: absolute; top: 100%; left: 0; right: 0;
  background: var(--surface); border: 1px solid rgba(255,255,255,0.08);
  border-radius: 0 0 var(--radius-sm) var(--radius-sm); max-height: 200px;
  overflow-y: auto; z-index: 100; display: none;
  box-shadow: var(--shadow-md);
}
.level-search .search-results .result-item {
  padding: 8px 12px; font-size: 12px; cursor: pointer;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  transition: var(--transition);
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
}
.level-search .search-results .result-item:hover { background: var(--accent); color: #000; }

/* ===== FULL PATH DISPLAY ===== */
.full-path-display {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--radius-md); padding: 12px 16px;
  border-left: 3px solid var(--accent);
  min-height: 44px;
}
.full-path-display .label {
  font-size: 11px; color: var(--text-dim); margin-bottom: 4px;
  text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;
}
.full-path-display .path {
  color: var(--accent); font-weight: 600;
  font-family: 'JetBrains Mono', monospace; font-size: 13px;
  line-height: 1.5; word-break: break-word; padding: 2px 0;
}

/* ===== NOTE SECTION ===== */
.note-section { display: flex; align-items: center; gap: 8px; }
.note-section label {
  font-size: 12px; color: var(--text-dim); flex-shrink: 0;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
}
.note-section textarea {
  flex: 1; background: rgba(255,255,255,0.04); color: var(--text);
  border: 1px solid rgba(255,255,255,0.08);
  padding: 8px 12px; border-radius: var(--radius-sm); font-size: 13px;
  resize: vertical; min-height: 40px;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  transition: var(--transition);
}
.note-section textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-dim);
  outline: none;
}

/* ===== KEYBOARD HINTS ===== */
.keyboard-hints {
  font-size: 11px; color: var(--text-dim); display: flex; gap: 12px; flex-wrap: wrap;
}
.keyboard-hints kbd {
  background: var(--surface3); border: 1px solid var(--border);
  border-radius: 4px; padding: 2px 7px;
  font-family: 'JetBrains Mono', monospace; font-size: 10px;
}

/* ===== NAVIGATION BUTTONS ===== */
.nav-buttons { display: flex; gap: 8px; margin-top: auto; padding-top: 8px; }
.nav-buttons button {
  padding: 10px 20px; border: 1px solid var(--border);
  border-radius: var(--radius-sm); font-size: 13px; font-weight: 600;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  cursor: pointer; background: var(--surface2); color: var(--text);
  transition: var(--transition);
}
.nav-buttons button:hover {
  border-color: var(--accent); color: var(--accent);
  transform: translateY(-1px);
}
.nav-buttons button.btn-primary {
  background: linear-gradient(135deg, var(--accent), #7c3aed);
  color: #fff; border-color: transparent; font-weight: 700;
  box-shadow: 0 2px 12px var(--accent-glow);
}
.nav-buttons button.btn-primary:hover {
  box-shadow: 0 4px 20px var(--accent-glow);
  transform: translateY(-1px);
}
.nav-buttons button.btn-export {
  background: linear-gradient(135deg, #34d399, #059669);
  color: #fff; border-color: transparent;
}
.nav-buttons button.btn-export:hover {
  box-shadow: 0 4px 16px rgba(52, 211, 153, 0.25);
  transform: translateY(-1px);
}
.nav-buttons button:disabled { opacity: 0.35; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

/* ===== BOTTOM BAR ===== */
.bottom-bar {
  background: rgba(20, 19, 26, 0.9);
  backdrop-filter: blur(12px);
  border-top: 1px solid var(--border);
  padding: 10px 24px;
  display: flex; align-items: center; gap: 16px;
}
.progress-bar-track {
  flex: 1; height: 6px; background: var(--surface3);
  border-radius: 3px; overflow: hidden;
}
.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--green));
  border-radius: 3px;
  transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 0 8px var(--accent-glow);
}
.stats {
  font-size: 12px; color: var(--text-dim); white-space: nowrap;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
}
.stats .done { color: var(--green); font-weight: 600; }

/* ===== UPLOAD FALLBACK ===== */
.upload-fallback {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg);
  z-index: 1000; display: flex; flex-direction: column; align-items: center;
  justify-content: center; gap: 24px; padding: 40px;
}
.upload-fallback h2 {
  color: var(--accent); font-size: 24px; font-weight: 700;
  letter-spacing: -0.02em;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
}
.upload-fallback p {
  color: var(--text-dim); font-size: 14px; text-align: center; max-width: 500px;
  line-height: 1.6;
}
.upload-fallback .upload-group { display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 500px; }
.upload-fallback .upload-item {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-md); padding: 20px; transition: var(--transition);
}
.upload-fallback .upload-item:hover { border-color: var(--border-accent); }
.upload-fallback .upload-item label {
  display: block; font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 8px;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
}
.upload-fallback .upload-item input[type="file"] {
  font-size: 12px; color: var(--text-dim);
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
}
.upload-fallback .upload-item .status { font-size: 12px; margin-top: 8px; }
.upload-fallback .upload-item .status.loaded { color: var(--green); font-weight: 500; }
.upload-fallback .upload-item .status.missing { color: var(--orange); }
.upload-fallback button.start-btn {
  background: linear-gradient(135deg, var(--accent), #7c3aed);
  color: #fff; border: none; padding: 14px 36px;
  border-radius: var(--radius-sm); font-size: 15px; font-weight: 700;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  cursor: pointer; box-shadow: 0 2px 16px var(--accent-glow);
  transition: var(--transition); margin-top: 10px;
}
.upload-fallback button.start-btn:hover {
  box-shadow: 0 4px 24px var(--accent-glow);
  transform: translateY(-1px);
}
.upload-fallback button.start-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; box-shadow: none; }

/* ===== TOAST ===== */
.toast {
  position: fixed; top: 24px; right: 24px;
  background: rgba(20, 19, 26, 0.92);
  backdrop-filter: blur(16px);
  border: 1px solid var(--border-accent);
  color: var(--text); padding: 14px 24px;
  border-radius: var(--radius-md); font-size: 13px; font-weight: 500;
  z-index: 600; opacity: 0; transform: translateX(20px);
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  pointer-events: none; box-shadow: var(--shadow-md);
}
.toast.show { opacity: 1; transform: translateX(0); }

/* ===== ACTIVE LEVEL INDICATOR ===== */
.level-row.active-level .level-label { color: var(--yellow); }

/* ===== LOGIN MODAL - Showstopper ===== */
.login-modal {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: #0c0b10;
  z-index: 2000; display: flex; align-items: center; justify-content: center;
  overflow: hidden;
}

.login-modal::before {
  content: '';
  position: absolute;
  top: -50%; left: -50%;
  width: 200%; height: 200%;
  background:
    radial-gradient(ellipse at 30% 40%, rgba(167, 139, 250, 0.08) 0%, transparent 50%),
    radial-gradient(ellipse at 70% 70%, rgba(139, 92, 246, 0.06) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 20%, rgba(196, 181, 253, 0.04) 0%, transparent 50%);
  animation: meshRotate 20s linear infinite;
}

@keyframes meshRotate {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes modalIn {
  0% { opacity: 0; transform: translateY(20px) scale(0.96); }
  100% { opacity: 1; transform: translateY(0) scale(1); }
}

.login-modal .login-card {
  background: rgba(20, 19, 26, 0.8);
  backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--radius-lg);
  padding: 48px 44px; width: 400px; max-width: 90vw;
  text-align: center;
  box-shadow: var(--shadow-lg);
  position: relative; z-index: 1;
  animation: modalIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}

.login-modal .login-card h2 {
  color: var(--accent);
  font-size: 22px; font-weight: 700; margin-bottom: 8px;
  letter-spacing: -0.02em;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
}

.login-modal .login-card .login-subtitle {
  color: var(--text-dim); font-size: 13px; margin-bottom: 28px;
}

.login-modal .login-card .login-field {
  display: flex; flex-direction: column; gap: 8px;
  text-align: left; margin-bottom: 24px;
}

.login-modal .login-card .login-field label {
  font-size: 12px; color: var(--text-dim); font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.05em;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
}

.login-modal .login-card .login-field input {
  width: 100%; background: rgba(255,255,255,0.04);
  color: var(--text); border: 1px solid rgba(255,255,255,0.08);
  padding: 12px 16px; border-radius: var(--radius-sm); font-size: 14px;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  outline: none; transition: var(--transition);
}

.login-modal .login-card .login-field input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-dim);
}

.login-modal .login-card .login-btn {
  width: 100%; padding: 14px 0;
  background: linear-gradient(135deg, var(--accent), #7c3aed);
  color: #fff; border: none;
  border-radius: var(--radius-sm); font-size: 15px; font-weight: 700;
  cursor: pointer;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  transition: var(--transition);
  box-shadow: 0 2px 16px var(--accent-glow);
}

.login-modal .login-card .login-btn:hover {
  box-shadow: 0 4px 24px var(--accent-glow);
  transform: translateY(-1px);
}

.login-modal .login-card .login-btn:disabled {
  opacity: 0.3; cursor: not-allowed; transform: none; box-shadow: none;
}

/* ===== ARBITRATOR IDENTITY IN TOP BAR ===== */
.arb-identity { display: flex; align-items: center; gap: 10px; margin-left: auto; }
.arb-identity #arbDisplay {
  font-size: 13px; color: var(--accent); font-weight: 600;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
}
.arb-identity .switch-user {
  font-size: 11px; color: var(--text-dim); cursor: pointer;
  text-decoration: none; padding: 3px 10px;
  border: 1px solid rgba(255,255,255,0.08); border-radius: 20px;
  transition: var(--transition);
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
}
.arb-identity .switch-user:hover {
  border-color: var(--accent); color: var(--accent);
}
</style>
</head>
<body>

<!-- Login Modal -->
<div class="login-modal" id="loginModal" style="display:none;">
  <div class="login-card">
    <h2>欢迎使用仲裁工具</h2>
    <div class="login-subtitle">请输入您的姓名以开始</div>
    <div class="login-field">
      <label>您的姓名</label>
      <input type="text" id="loginNameInput" placeholder="请输入姓名..." autocomplete="off">
    </div>
    <button class="login-btn" id="loginBtn" disabled>开始</button>
  </div>
</div>

<!-- Upload Fallback -->
<div class="upload-fallback" id="uploadFallback" style="display:none;">
  <h2>仲裁工具 v1.0</h2>
  <p>请上传所需文件以开始仲裁。</p>
  <div class="upload-group">
    <div class="upload-item">
      <label>标签树 JSON (visual_elements_global.json)</label>
      <input type="file" accept=".json,.js" id="uploadTaxonomy">
      <div class="status" id="statusTaxonomy"><span class="missing">未加载</span></div>
    </div>
    <div class="upload-item">
      <label>仲裁输入 CSV (arbitration_input.csv)</label>
      <input type="file" accept=".csv" id="uploadArbTasks">
      <div class="status" id="statusArbTasks"><span class="missing">未加载</span></div>
    </div>
  </div>
  <button class="start-btn" id="startBtn" disabled>开始仲裁</button>
</div>

<!-- Main UI -->
<div class="top-bar" id="topBar">
  <span class="title">仲裁工具 v1.0</span>
  <div class="controls">
    <span class="progress-text">
      <span id="currentIdx">0</span> / <span id="totalCount">0</span>
    </span>
  </div>
  <div class="arb-identity">
    <span id="arbDisplay">仲裁员: --</span>
    <a class="switch-user" id="switchUserBtn">切换用户</a>
  </div>
</div>
<div class="taxonomy-link">
  查看标签树: <a href="https://rajeshzheng.github.io/ls-taxonomy-v2_202602/" target="_blank">https://rajeshzheng.github.io/ls-taxonomy-v2_202602/</a>
</div>

<div class="main-content" id="mainContent">
  <!-- Left Panel: Image + History + Rules -->
  <div class="left-panel">
    <div class="image-section" id="imageSection">
      <div class="placeholder" id="imagePlaceholder">加载仲裁数据后开始</div>
      <div class="image-loading" id="imageLoading"><div class="spinner"></div><span>加载中...</span></div>
      <img id="taskImage" style="display:none;" alt="Task image">
    </div>
    <div class="task-info">
      <span class="task-id" id="taskIdDisplay">--</span>
      <span id="taskSourceDisplay"></span>
    </div>

    <!-- All history -->
    <div class="history-panel" id="historyPanel">
      <div class="panel-title">历史标注与审核记录</div>
      <div id="historyContent"></div>
    </div>

    <!-- Boundary rules -->
    <div class="rules-panel">
      <div class="panel-title">边界规则摘要</div>
      <div class="rule-text" id="rulesText">
1. 同一物体可能属于多个类别时，选择"最具体"的类别
2. 背景元素不标注，仅标注主体
3. 美食类: 明确的菜品/食材按具体分类; 餐厅场景归入"美食/餐饮文化"
4. 旅游/全球地点: 仅保留 22 个主要国家; 其余归入所属大洲
5. 艺术类: 摄影作品按拍摄主体分类，不归入"艺术/摄影"（已删除）
6. 座驾类: 汽车品牌按品牌归入; 非品牌汽车归入对应车型类别
7. 体育类: 电子竞技归入"体育/电子竞技"; 传统棋牌归入"娱乐"
8. 动物类: 宠物优先归入"动物/宠物"而非物种类别
9. 当标注员和审核员意见不一致时，优先参考 AI 预测 + 人工参考标签
10. 不确定时，选择更上层（更宽泛）的类别比选错更好
      </div>
    </div>
  </div>

  <!-- Right Panel -->
  <div class="right-panel" id="rightPanel">
    <!-- Decision -->
    <div class="decision-section">
      <div class="section-title">仲裁决策</div>
      <div class="decision-options" id="decisionOptions"></div>
    </div>

    <!-- Level Selectors -->
    <div class="selector-section" id="selectorSection" style="display:none;">
      <div class="level-row" data-level="1" id="levelRow1">
        <span class="level-label">L1</span>
        <div class="level-select-wrapper"><select id="selectL1"><option value="">-- 请选择 L1 --</option></select></div>
      </div>
      <div class="level-row" data-level="2" id="levelRow2">
        <span class="level-label">L2</span>
        <div class="level-select-wrapper"><select id="selectL2" disabled><option value="">-- 请选择 L2 --</option></select></div>
      </div>
      <div class="level-row" data-level="3" id="levelRow3">
        <span class="level-label">L3</span>
        <div class="level-select-wrapper"><select id="selectL3" disabled><option value="">-- 请选择 L3 --</option></select></div>
        <div class="level-search" id="searchL3">
          <input type="text" placeholder="搜索 L3..." id="searchInputL3">
          <div class="search-results" id="searchResultsL3"></div>
        </div>
      </div>
      <div class="level-row" data-level="4" id="levelRow4">
        <span class="level-label">L4</span>
        <div class="level-select-wrapper"><select id="selectL4" disabled><option value="">-- 请选择 L4 --</option></select></div>
        <div class="level-search" id="searchL4">
          <input type="text" placeholder="搜索 L4..." id="searchInputL4">
          <div class="search-results" id="searchResultsL4"></div>
        </div>
      </div>
      <div class="level-row" data-level="5" id="levelRow5">
        <span class="level-label">L5</span>
        <div class="level-select-wrapper"><select id="selectL5" disabled><option value="">-- 请选择 L5 --</option></select></div>
        <div class="level-search" id="searchL5">
          <input type="text" placeholder="搜索 L5..." id="searchInputL5">
          <div class="search-results" id="searchResultsL5"></div>
        </div>
      </div>
    </div>

    <div class="full-path-display">
      <div class="label">最终路径</div>
      <div class="path" id="fullPathDisplay">--</div>
    </div>

    <!-- Note -->
    <div class="note-section">
      <label>裁决理由:</label>
      <textarea id="noteInput" placeholder="请填写裁决理由..." rows="2"></textarea>
    </div>

    <div class="keyboard-hints">
      <span><kbd>Enter</kbd> 确认</span>
      <span><kbd>&larr;</kbd><kbd>&rarr;</kbd> 导航</span>
    </div>

    <div class="nav-buttons">
      <button id="btnPrev">&larr; 上一条</button>
      <button id="btnConfirm" class="btn-primary">确认并下一条 &rarr;</button>
      <button id="btnExport" class="btn-export">导出 CSV</button>
    </div>
  </div>
</div>

<div class="bottom-bar" id="bottomBar">
  <div class="progress-bar-track">
    <div class="progress-bar-fill" id="progressBarFill" style="width:0%"></div>
  </div>
  <div class="stats"><span id="statsText">已完成: 0 | 剩余: 0</span></div>
</div>

<div class="toast" id="toast"></div>

<script>
(function() {
  'use strict';

  // ========== STATE ==========
  let taxonomyData = null;
  let arbTasks = [];
  let currentIndex = 0;
  let arbitrations = {};
  let dataReady = false;
  let currentDecision = '';
  let activeLevel = null;
  let arbitratorName = '';

  // ========== CSV PARSER ==========
  function parseCSV(csvStr) {
    if (!csvStr || !csvStr.trim()) return [];
    const lines = csvStr.trim().replace(/^\ufeff/, '').split('\n');
    if (lines.length < 2) return [];
    const headers = parseCSVLine(lines[0]);
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const vals = parseCSVLine(lines[i]);
      if (vals.length === 0 || (vals.length === 1 && vals[0] === '')) continue;
      const obj = {};
      for (let j = 0; j < headers.length; j++) {
        obj[headers[j].trim()] = (vals[j] || '').trim();
      }
      rows.push(obj);
    }
    return rows;
  }

  function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const c = line[i];
      if (inQuotes) {
        if (c === '"') {
          if (i + 1 < line.length && line[i + 1] === '"') { current += '"'; i++; }
          else { inQuotes = false; }
        } else { current += c; }
      } else {
        if (c === '"') { inQuotes = true; }
        else if (c === ',') { result.push(current); current = ''; }
        else { current += c; }
      }
    }
    result.push(current);
    return result;
  }

  // ========== TAXONOMY ==========
  let l1Nodes = [];
  let nodeMap = {};

  function buildTreeIndex(tree) {
    if (!tree || !tree.children) return;
    l1Nodes = []; nodeMap = {};
    function walk(node, depth, parentPath, parentPathEn) {
      const zh = node.name || '', en = node.name_en || '';
      const path = parentPath ? parentPath + '/' + zh : zh;
      const pathEn = parentPathEn ? parentPathEn + '/' + en : en;
      const entry = { name: zh, name_en: en, path, path_en: pathEn, depth, children: [] };
      nodeMap[path] = entry;
      if (node.children && node.children.length > 0) {
        for (const child of node.children) { entry.children.push(walk(child, depth + 1, path, pathEn)); }
        entry.children.sort((a, b) => (a.name_en || '').localeCompare(b.name_en || ''));
      }
      return entry;
    }
    for (const child of tree.children) { l1Nodes.push(walk(child, 1, '', '')); }
    l1Nodes.sort((a, b) => (a.name_en || '').localeCompare(b.name_en || ''));
  }

  // Bilingual display: "中文名 (English Name)" for arbitrator
  function populateSelect(selectEl, nodes, placeholder) {
    selectEl.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value = ''; opt0.textContent = placeholder || '-- 请选择 --';
    selectEl.appendChild(opt0);
    selectEl.classList.remove('user-selected');
    if (!nodes) return;
    for (const node of nodes) {
      const opt = document.createElement('option');
      opt.value = node.path;
      opt.textContent = (node.name || '') + ' (' + (node.name_en || '') + ')';
      opt.dataset.name = node.name;
      opt.dataset.nameEn = node.name_en;
      selectEl.appendChild(opt);
    }
    selectEl.disabled = false;
  }

  function disableSelectsFrom(level) {
    for (let i = level; i <= 5; i++) {
      const sel = document.getElementById('selectL' + i);
      sel.innerHTML = '<option value="">--- 无 ---</option>';
      sel.disabled = true; sel.classList.remove('user-selected');
      const s = document.getElementById('searchL' + i);
      if (s) s.style.display = 'none';
    }
  }

  function onLevelChange(level) {
    const sel = document.getElementById('selectL' + level);
    const path = sel.value;
    disableSelectsFrom(level + 1);
    if (!path) {
      sel.classList.remove('user-selected');
      updateFullPath();
      return;
    }
    sel.classList.add('user-selected');
    const node = nodeMap[path];
    if (node && node.children && node.children.length > 0) {
      const next = level + 1;
      if (next <= 5) {
        const nextSel = document.getElementById('selectL' + next);
        populateSelect(nextSel, node.children, '-- 请选择 L' + next + ' --');
        if (next >= 3) {
          const sd = document.getElementById('searchL' + next);
          if (sd) sd.style.display = 'block';
        }
        setActiveLevel(next);
      }
    }
    updateFullPath();
  }

  function setActiveLevel(level) {
    activeLevel = level;
    for (let i = 1; i <= 5; i++) {
      document.getElementById('levelRow' + i).classList.toggle('active-level', i === level);
    }
  }

  function getSelectedPath() {
    let path = '', pathEn = '';
    for (let i = 1; i <= 5; i++) {
      const sel = document.getElementById('selectL' + i);
      if (sel.disabled || !sel.value) break;
      const opt = sel.options[sel.selectedIndex];
      path += (path ? '/' : '') + (opt ? opt.dataset.name || '' : '');
      pathEn += (pathEn ? '/' : '') + (opt ? opt.dataset.nameEn || '' : '');
    }
    return { path, pathEn };
  }

  function updateFullPath() {
    const display = document.getElementById('fullPathDisplay');
    if (currentDecision && currentDecision !== 'NEW_PATH') {
      const task = arbTasks[currentIndex];
      const p = getArbPathForDecision(task, currentDecision);
      if (p) { display.textContent = p; return; }
    }
    const { path, pathEn } = getSelectedPath();
    display.textContent = path ? path + ' (' + pathEn + ')' : '--';
  }

  function setSelectorsFromPath(zhPath) {
    if (!zhPath) return;
    const parts = zhPath.split('/');
    let cp = '';
    for (let i = 0; i < parts.length && i < 5; i++) {
      cp += (cp ? '/' : '') + parts[i];
      const level = i + 1;
      const sel = document.getElementById('selectL' + level);
      if (sel.disabled) break;
      let found = false;
      for (let j = 0; j < sel.options.length; j++) {
        if (sel.options[j].value === cp) {
          sel.selectedIndex = j; sel.classList.add('user-selected'); found = true; break;
        }
      }
      if (!found) break;
      const node = nodeMap[cp];
      if (node && node.children && node.children.length > 0) {
        const next = level + 1;
        if (next <= 5) {
          populateSelect(document.getElementById('selectL' + next), node.children, '-- 请选择 L' + next + ' --');
          if (next >= 3) {
            const sd = document.getElementById('searchL' + next);
            if (sd) sd.style.display = 'block';
          }
        }
      }
    }
    updateFullPath();
  }

  function resetSelectors() {
    populateSelect(document.getElementById('selectL1'), l1Nodes, '-- 请选择 L1 --');
    disableSelectsFrom(2); setActiveLevel(1);
    document.getElementById('selectL1').classList.remove('user-selected');
    updateFullPath();
  }

  function setupSearch(level) {
    const input = document.getElementById('searchInputL' + level);
    const results = document.getElementById('searchResultsL' + level);
    if (!input || !results) return;
    input.addEventListener('input', function() {
      const q = this.value.toLowerCase().trim();
      results.innerHTML = '';
      if (!q) { results.style.display = 'none'; return; }
      const sel = document.getElementById('selectL' + level);
      const matches = [];
      for (let i = 1; i < sel.options.length; i++) {
        if (sel.options[i].textContent.toLowerCase().includes(q))
          matches.push({ index: i, text: sel.options[i].textContent });
      }
      if (!matches.length) { results.style.display = 'none'; return; }
      results.style.display = 'block';
      for (const m of matches.slice(0, 20)) {
        const div = document.createElement('div');
        div.className = 'result-item'; div.textContent = m.text;
        div.addEventListener('click', function() {
          sel.selectedIndex = m.index; onLevelChange(level);
          input.value = ''; results.style.display = 'none';
        });
        results.appendChild(div);
      }
    });
    input.addEventListener('blur', function() { setTimeout(() => { results.style.display = 'none'; }, 200); });
  }

  // ========== HISTORY BUILDING ==========
  function getAnnotatorKeys(task) {
    const keys = [];
    for (const key of Object.keys(task)) {
      const m = key.match(/^ann_([A-Z])_path$/);
      if (m) keys.push(m[1]);
    }
    return keys;
  }

  function buildHistory(task) {
    const container = document.getElementById('historyContent');
    container.innerHTML = '';
    const decisionOptions = document.getElementById('decisionOptions');
    decisionOptions.innerHTML = '';

    // --- Annotators ---
    const annKeys = getAnnotatorKeys(task);
    if (annKeys.length > 0) {
      const group = document.createElement('div');
      group.className = 'history-group';
      group.innerHTML = '<div class="group-title">标注员标注</div>';

      for (const k of annKeys) {
        const path = task['ann_' + k + '_path'] || '';
        const action = task['ann_' + k + '_action'] || '';
        const uncertain = task['ann_' + k + '_uncertain'] === 'true';

        const row = document.createElement('div');
        row.className = 'history-row neutral';
        row.innerHTML =
          '<span class="row-label">标注员 ' + k + ':</span>' +
          '<span class="row-path">' + (path || '(空)') + '</span>' +
          '<span class="row-meta" style="background:rgba(100,100,100,0.2)">' +
          action + (uncertain ? ' [不确定]' : '') + '</span>';
        group.appendChild(row);

        const rl = document.createElement('label');
        rl.innerHTML = '<input type="radio" name="decision" value="PICK_ANN_' + k + '"> 选标注员 ' + k;
        decisionOptions.appendChild(rl);
      }
      container.appendChild(group);
    }

    // --- Reviewers ---
    const hasR1 = task.rev1_path || task.rev1_source;
    const hasR2 = task.rev2_path || task.rev2_source;
    if (hasR1 || hasR2) {
      const group = document.createElement('div');
      group.className = 'history-group';
      group.innerHTML = '<div class="group-title">审核员决策</div>';

      if (hasR1) {
        const row = document.createElement('div');
        const agree = task.rev1_path === task.rev2_path;
        row.className = 'history-row ' + (agree ? 'agree' : 'disagree');
        row.innerHTML =
          '<span class="row-label">审核员 R1:</span>' +
          '<span class="row-path">' + (task.rev1_path || '--') + '</span>' +
          '<span class="row-meta" style="background:rgba(79,195,247,0.2)">' + (task.rev1_source || '') + '</span>';
        if (task.rev1_note) {
          row.innerHTML += '<br><span style="font-size:11px;color:var(--text-dim);margin-left:58px;">理由: ' + task.rev1_note + '</span>';
        }
        group.appendChild(row);

        const rl1 = document.createElement('label');
        rl1.innerHTML = '<input type="radio" name="decision" value="PICK_R1"> 选 R1';
        decisionOptions.appendChild(rl1);
      }

      if (hasR2) {
        const row = document.createElement('div');
        const agree = task.rev1_path === task.rev2_path;
        row.className = 'history-row ' + (agree ? 'agree' : 'disagree');
        row.innerHTML =
          '<span class="row-label">审核员 R2:</span>' +
          '<span class="row-path">' + (task.rev2_path || '--') + '</span>' +
          '<span class="row-meta" style="background:rgba(79,195,247,0.2)">' + (task.rev2_source || '') + '</span>';
        if (task.rev2_note) {
          row.innerHTML += '<br><span style="font-size:11px;color:var(--text-dim);margin-left:58px;">理由: ' + task.rev2_note + '</span>';
        }
        group.appendChild(row);

        const rl2 = document.createElement('label');
        rl2.innerHTML = '<input type="radio" name="decision" value="PICK_R2"> 选 R2';
        decisionOptions.appendChild(rl2);
      }
      container.appendChild(group);
    }

    // --- AI ---
    if (task.ai_path) {
      const group = document.createElement('div');
      group.className = 'history-group';
      group.innerHTML = '<div class="group-title">AI 预测</div>';
      const row = document.createElement('div');
      row.className = 'history-row neutral';
      row.innerHTML =
        '<span class="row-label">AI:</span>' +
        '<span class="row-path" style="color:#888">' + task.ai_path + '</span>';
      group.appendChild(row);
      container.appendChild(group);

      const rlAI = document.createElement('label');
      rlAI.innerHTML = '<input type="radio" name="decision" value="PICK_AI"> 选 AI';
      decisionOptions.appendChild(rlAI);
    }

    // --- Human ref ---
    if (task.source === '780' && task.human_ref_path) {
      const group = document.createElement('div');
      group.className = 'history-group';
      group.innerHTML = '<div class="group-title">原始人工标签 (780)</div>';
      const row = document.createElement('div');
      row.className = 'history-row neutral';
      row.innerHTML =
        '<span class="row-label">人工:</span>' +
        '<span class="row-path" style="color:var(--green)">' + task.human_ref_path + '</span>';
      group.appendChild(row);
      container.appendChild(group);
    }

    // New path option
    const rlNew = document.createElement('label');
    rlNew.innerHTML = '<input type="radio" name="decision" value="NEW_PATH"> 新路径';
    decisionOptions.appendChild(rlNew);

    // Decision change handler
    decisionOptions.querySelectorAll('input[type="radio"]').forEach(radio => {
      radio.addEventListener('change', function() {
        currentDecision = this.value;
        decisionOptions.querySelectorAll('label').forEach(l => l.classList.remove('selected'));
        this.parentElement.classList.add('selected');
        if (this.value === 'NEW_PATH') {
          document.getElementById('selectorSection').style.display = 'flex';
          resetSelectors();
        } else {
          document.getElementById('selectorSection').style.display = 'none';
          const p = getArbPathForDecision(task, this.value);
          document.getElementById('fullPathDisplay').textContent = p || '--';
        }
      });
    });
  }

  function getArbPathForDecision(task, decision) {
    if (!task || !decision) return '';
    if (decision.startsWith('PICK_ANN_')) {
      const k = decision.replace('PICK_ANN_', '');
      return task['ann_' + k + '_path'] || '';
    }
    if (decision === 'PICK_R1') return task.rev1_path || '';
    if (decision === 'PICK_R2') return task.rev2_path || '';
    if (decision === 'PICK_AI') return task.ai_path || '';
    return '';
  }

  function getArbPathEnForDecision(task, decision) {
    if (!task || !decision) return '';
    const zhPath = getArbPathForDecision(task, decision);
    return pathToEn(zhPath);
  }

  function pathToEn(zhPath) {
    if (!zhPath) return '';
    const node = nodeMap[zhPath];
    return node ? node.path_en : zhPath;
  }

  // ========== TASK LOADING ==========
  function loadTask(index) {
    if (!arbTasks.length) return;
    if (index < 0) index = 0;
    if (index >= arbTasks.length) index = arbTasks.length - 1;
    currentIndex = index;
    currentDecision = '';

    const task = arbTasks[index];
    document.getElementById('currentIdx').textContent = index + 1;
    document.getElementById('totalCount').textContent = arbTasks.length;

    const img = document.getElementById('taskImage');
    const placeholder = document.getElementById('imagePlaceholder');
    const loading = document.getElementById('imageLoading');
    if (task.upload_url) {
      img.style.display = 'none';
      placeholder.style.display = 'none';
      loading.classList.add('active');
      img.onload = function() { loading.classList.remove('active'); img.style.display = 'block'; };
      img.onerror = function() { loading.classList.remove('active'); img.style.display = 'none'; placeholder.style.display = 'block'; placeholder.textContent = '图片加载失败'; };
      img.src = task.upload_url;
    } else {
      loading.classList.remove('active');
      img.style.display = 'none'; placeholder.style.display = 'block'; placeholder.textContent = '无图片链接';
    }

    document.getElementById('taskIdDisplay').textContent = task.task_id || '--';
    document.getElementById('taskSourceDisplay').textContent = task.source ? ' | 来源: ' + task.source : '';

    buildHistory(task);

    document.getElementById('selectorSection').style.display = 'none';
    document.getElementById('fullPathDisplay').textContent = '--';
    document.getElementById('noteInput').value = '';

    // Restore saved
    const saved = arbitrations[task.task_id];
    if (saved) {
      currentDecision = saved.arb_source;
      const radios = document.querySelectorAll('input[name="decision"]');
      for (const r of radios) {
        if (r.value === saved.arb_source) {
          r.checked = true; r.parentElement.classList.add('selected'); break;
        }
      }
      if (saved.arb_source === 'NEW_PATH') {
        document.getElementById('selectorSection').style.display = 'flex';
        resetSelectors();
        setSelectorsFromPath(saved.final_path);
      } else {
        document.getElementById('fullPathDisplay').textContent = saved.final_path || '--';
      }
      document.getElementById('noteInput').value = saved.arb_note || '';
    }

    updateStats();
    updateProgressBar();
  }

  // ========== ARBITRATIONS ==========
  function saveArbitration() {
    const task = arbTasks[currentIndex];
    if (!task) return false;
    if (!currentDecision) { showToast('请选择一个决策'); return false; }

    let finalPath = '', finalPathEn = '';
    if (currentDecision === 'NEW_PATH') {
      const sel = getSelectedPath();
      finalPath = sel.path; finalPathEn = sel.pathEn;
      if (!finalPath) { showToast('请选择新路径'); return false; }
    } else {
      finalPath = getArbPathForDecision(task, currentDecision);
      finalPathEn = getArbPathEnForDecision(task, currentDecision);
    }

    // P0-3: 校验最终路径非空，无论 decision_source 是什么。
    // 选择的标注员/审核员路径可能为空（如 uncertain 场景）。
    if (!finalPath) {
      showToast('所选路径为空（标注员/审核员可能标记了不确定），请选择其他选项或使用新路径。');
      return false;
    }

    arbitrations[task.task_id] = {
      task_id: task.task_id,
      final_path: finalPath,
      final_path_en: finalPathEn,
      arb_source: currentDecision,
      arb_note: document.getElementById('noteInput').value.trim(),
      timestamp: new Date().toISOString()
    };

    persistToLocalStorage();

    const count = Object.keys(arbitrations).length;
    if (count > 0 && count % 100 === 0) {
      showToast('已完成 ' + count + ' 条仲裁，建议导出备份！');
    }
    return true;
  }

  function persistToLocalStorage() {
    const key = 'ssa_arbitration_arb1';
    try { localStorage.setItem(key, JSON.stringify(arbitrations)); } catch (e) {}
  }

  function loadFromLocalStorage() {
    const key = 'ssa_arbitration_arb1';
    try {
      const data = localStorage.getItem(key);
      if (data) {
        arbitrations = JSON.parse(data);
        showToast('已恢复 ' + Object.keys(arbitrations).length + ' 条仲裁记录');
      } else { arbitrations = {}; }
    } catch (e) { arbitrations = {}; }
  }

  function updateStats() {
    const total = arbTasks.length;
    const done = Object.keys(arbitrations).filter(id => arbTasks.some(t => t.task_id === id)).length;
    document.getElementById('statsText').innerHTML =
      '已完成: <span class="done">' + done + '</span> | 剩余: ' + (total - done);
  }

  function updateProgressBar() {
    const total = arbTasks.length;
    if (!total) return;
    const done = Object.keys(arbitrations).filter(id => arbTasks.some(t => t.task_id === id)).length;
    document.getElementById('progressBarFill').style.width = (done / total * 100).toFixed(1) + '%';
  }

  // ========== EXPORT ==========
  function exportCSV() {
    const taskArbs = arbTasks.map(t => arbitrations[t.task_id]).filter(a => a);
    if (!taskArbs.length) { showToast('没有可导出的仲裁记录'); return; }

    const now = new Date();
    const ts = now.getFullYear().toString() +
      String(now.getMonth() + 1).padStart(2, '0') +
      String(now.getDate()).padStart(2, '0') + '_' +
      String(now.getHours()).padStart(2, '0') +
      String(now.getMinutes()).padStart(2, '0') +
      String(now.getSeconds()).padStart(2, '0');

    const safeName = arbitratorName ? arbitratorName.replace(/[^a-zA-Z0-9\u4e00-\u9fff_-]/g, '_') : 'unknown';
    const filename = 'arbitration_' + safeName + '_' + ts + '.csv';
    const header = 'task_id,final_path,final_path_en,arb_source,arb_note,timestamp';
    const rows = taskArbs.map(a => [
      csvEscape(a.task_id), csvEscape(a.final_path), csvEscape(a.final_path_en),
      csvEscape(a.arb_source), csvEscape(a.arb_note), csvEscape(a.timestamp)
    ].join(','));

    const bom = '\ufeff';
    const blob = new Blob([bom + header + '\n' + rows.join('\n') + '\n'], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('已导出 ' + taskArbs.length + ' 条仲裁: ' + filename);
  }

  function csvEscape(val) {
    if (val == null) return '';
    val = String(val);
    if (val.includes(',') || val.includes('"') || val.includes('\n'))
      return '"' + val.replace(/"/g, '""') + '"';
    return val;
  }

  function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg; toast.classList.add('show');
    setTimeout(() => { toast.classList.remove('show'); }, 3000);
  }

  // ========== LOGIN ==========
  function checkLoginAndInit() {
    try {
      const stored = localStorage.getItem('ssa_arbitrator_identity');
      if (stored) {
        const identity = JSON.parse(stored);
        if (identity && identity.name) {
          arbitratorName = identity.name;
          applyIdentity();
          initApp();
          return;
        }
      }
    } catch (e) {}
    showLoginModal();
  }

  function showLoginModal() {
    const modal = document.getElementById('loginModal');
    modal.style.display = 'flex';
    const nameInput = document.getElementById('loginNameInput');
    const loginBtn = document.getElementById('loginBtn');

    nameInput.value = '';
    loginBtn.disabled = true;

    nameInput.addEventListener('input', function() {
      loginBtn.disabled = !this.value.trim();
    });

    nameInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && this.value.trim()) { doLogin(); }
    });

    loginBtn.addEventListener('click', doLogin);

    setTimeout(function() { nameInput.focus(); }, 100);
  }

  function doLogin() {
    const nameInput = document.getElementById('loginNameInput');
    const name = nameInput.value.trim();
    if (!name) return;

    arbitratorName = name;
    try {
      localStorage.setItem('ssa_arbitrator_identity', JSON.stringify({ name: name }));
    } catch (e) {}

    applyIdentity();
    document.getElementById('loginModal').style.display = 'none';
    initApp();
  }

  function applyIdentity() {
    document.getElementById('arbDisplay').textContent = '仲裁员: ' + arbitratorName;
  }

  function switchUser() {
    try { localStorage.removeItem('ssa_arbitrator_identity'); } catch (e) {}
    arbitratorName = '';
    showLoginModal();
  }

  // ========== INIT ==========
  function initApp() {
    const hasTaxonomy = typeof window.TREE_A !== 'undefined' && window.TREE_A;
    const hasArbTasks = typeof window.ARBITRATION_TASKS !== 'undefined' && window.ARBITRATION_TASKS;

    if (hasTaxonomy) { taxonomyData = window.TREE_A; buildTreeIndex(taxonomyData); }
    if (hasArbTasks) { arbTasks = parseCSV(window.ARBITRATION_TASKS); }

    if (!hasTaxonomy || !hasArbTasks) {
      showUploadFallback(hasTaxonomy, hasArbTasks);
    } else {
      dataReady = true;
      populateSelect(document.getElementById('selectL1'), l1Nodes, '-- 请选择 L1 --');
      loadFromLocalStorage();
      if (arbTasks.length > 0) {
        let startIdx = 0;
        for (let i = 0; i < arbTasks.length; i++) {
          if (!arbitrations[arbTasks[i].task_id]) { startIdx = i; break; }
        }
        loadTask(startIdx);
      }
    }

    setupEventListeners();
    setupSearch(3); setupSearch(4); setupSearch(5);
  }

  function showUploadFallback(hasTax, hasArb) {
    const fallback = document.getElementById('uploadFallback');
    fallback.style.display = 'flex';
    if (hasTax) document.getElementById('statusTaxonomy').innerHTML = '<span class="loaded">已加载 (自动)</span>';
    if (hasArb) document.getElementById('statusArbTasks').innerHTML = '<span class="loaded">已加载 (自动)</span>';

    document.getElementById('uploadTaxonomy').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        try {
          const text = ev.target.result;
          try { taxonomyData = JSON.parse(text); } catch (_) {
            eval(text);
            if (window.TREE_A) taxonomyData = window.TREE_A;
          }
          if (taxonomyData) {
            buildTreeIndex(taxonomyData);
            document.getElementById('statusTaxonomy').innerHTML = '<span class="loaded">已加载</span>';
            checkReady();
          }
        } catch (err) {
          document.getElementById('statusTaxonomy').innerHTML = '<span class="missing">错误: ' + err.message + '</span>';
        }
      };
      reader.readAsText(file);
    });

    document.getElementById('uploadArbTasks').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        arbTasks = parseCSV(ev.target.result);
        document.getElementById('statusArbTasks').innerHTML =
          '<span class="loaded">已加载 ' + arbTasks.length + ' 条仲裁任务</span>';
        checkReady();
      };
      reader.readAsText(file);
    });

    document.getElementById('startBtn').addEventListener('click', function() {
      fallback.style.display = 'none';
      dataReady = true;
      populateSelect(document.getElementById('selectL1'), l1Nodes, '-- 请选择 L1 --');
      loadFromLocalStorage();
      if (arbTasks.length > 0) {
        let startIdx = 0;
        for (let i = 0; i < arbTasks.length; i++) {
          if (!arbitrations[arbTasks[i].task_id]) { startIdx = i; break; }
        }
        loadTask(startIdx);
      }
    });
  }

  function checkReady() {
    document.getElementById('startBtn').disabled = !(taxonomyData && arbTasks.length > 0);
  }

  // ========== EVENT LISTENERS ==========
  function setupEventListeners() {
    for (let i = 1; i <= 5; i++) {
      (function(level) {
        document.getElementById('selectL' + level).addEventListener('change', function() { onLevelChange(level); });
        document.getElementById('selectL' + level).addEventListener('focus', function() { setActiveLevel(level); });
      })(i);
    }

    document.getElementById('btnPrev').addEventListener('click', function() { goTo(currentIndex - 1); });
    document.getElementById('btnConfirm').addEventListener('click', doConfirm);
    document.getElementById('btnExport').addEventListener('click', exportCSV);

    document.addEventListener('keydown', function(e) {
      const tag = e.target.tagName.toLowerCase();
      if (tag === 'input' || tag === 'textarea') return;
      if (e.key === 'Enter') { e.preventDefault(); doConfirm(); }
      else if (e.key === 'ArrowLeft') { e.preventDefault(); goTo(currentIndex - 1); }
      else if (e.key === 'ArrowRight') { e.preventDefault(); goTo(currentIndex + 1); }
    });
  }

  function doConfirm() {
    if (!arbTasks.length) return;
    if (saveArbitration()) {
      if (currentIndex < arbTasks.length - 1) { loadTask(currentIndex + 1); }
      else { showToast('所有任务已完成！请导出结果。'); }
    }
  }

  function goTo(index) {
    if (index < 0 || index >= arbTasks.length) return;
    loadTask(index);
  }

  document.getElementById('switchUserBtn').addEventListener('click', function(e) {
    e.preventDefault();
    switchUser();
  });

  checkLoginAndInit();
})();
</script>
</body>
</html>
