<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image Annotation Tool v1.0</title>
<script src="../taxonomy/visual_elements_global.js"></script>
<script src="../tasks/annotation_tasks_780.js"></script>
<script src="../tasks/annotation_tasks_1000.js"></script>
<script src="../tasks/assignment_manifest.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
<style>
/* ===== OBSIDIAN STUDIO - AMBER GOLD THEME ===== */
:root {
  --bg: #0c0b10;
  --surface: #14131a;
  --surface2: #1c1b24;
  --surface3: #26253a;
  --text: #ece9e4;
  --text-dim: #7a7888;
  --accent: #e8a848;
  --accent-hover: #f0be6c;
  --accent-dim: rgba(232, 168, 72, 0.10);
  --accent-glow: rgba(232, 168, 72, 0.25);
  --green: #34d399;
  --red: #fb7185;
  --orange: #fb923c;
  --yellow: #fde68a;
  --border: rgba(255,255,255,0.06);
  --border-accent: rgba(232, 168, 72, 0.20);
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 24px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 48px rgba(0,0,0,0.5);
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 16px;
  --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

/* ===== CUSTOM SCROLLBAR ===== */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.15); }

body {
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  color-scheme: dark;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ===== TOP BAR - FROSTED GLASS ===== */
.top-bar {
  background: rgba(20, 19, 26, 0.85);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  padding: 12px 24px;
  display: flex;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
  min-height: 48px;
}

.top-bar .title {
  font-size: 15px;
  font-weight: 700;
  color: var(--accent);
  letter-spacing: -0.02em;
  white-space: nowrap;
}

.top-bar .controls {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.top-bar label {
  font-size: 13px;
  color: var(--text-dim);
  font-weight: 500;
}

.top-bar select {
  background: var(--surface2);
  color: var(--text);
  color-scheme: dark;
  border: 1px solid var(--border);
  padding: 5px 10px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  cursor: pointer;
  transition: var(--transition);
}

.top-bar select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-dim);
  outline: none;
}

.top-bar select option {
  background: var(--surface2);
  color: var(--text);
}

.top-bar .progress-text {
  font-size: 13px;
  color: var(--text-dim);
}

.top-bar .progress-text span {
  color: var(--accent);
  font-weight: 600;
}

/* ===== TAXONOMY LINK BAR ===== */
.taxonomy-link {
  font-size: 11px;
  background: rgba(20, 19, 26, 0.6);
  padding: 6px 24px;
  border-bottom: 1px solid var(--border);
}

.taxonomy-link a {
  color: var(--accent);
  text-decoration: none;
  font-weight: 500;
  transition: var(--transition);
}

.taxonomy-link a:hover {
  color: var(--accent-hover);
  text-decoration: underline;
}

/* ===== MAIN CONTENT ===== */
.main-content {
  display: flex;
  flex: 1;
  overflow: hidden;
}

/* ===== LEFT PANEL ===== */
.left-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  border-right: 1px solid var(--border);
  min-width: 300px;
  overflow: auto;
}

/* ===== IMAGE CONTAINER ===== */
.image-container {
  position: relative;
  max-width: 100%;
  max-height: calc(100vh - 250px);
  display: flex;
  align-items: center;
  justify-content: center;
  background: #08080c;
  border-radius: var(--radius-md);
  border: 1px solid var(--border);
  box-shadow: var(--shadow-md);
  overflow: hidden;
  position: relative;
  min-height: 200px;
  width: 100%;
}

.image-container img {
  max-width: 100%;
  max-height: calc(100vh - 260px);
  object-fit: contain;
}

.image-container .placeholder {
  color: var(--text-dim);
  font-size: 14px;
  text-align: center;
  padding: 40px;
}

/* Image loading spinner */
.image-loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: none;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  z-index: 2;
}

.image-loading.active {
  display: flex;
}

.spinner {
  width: 36px;
  height: 36px;
  border: 3px solid var(--surface3);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.image-loading span {
  font-size: 12px;
  color: var(--text-dim);
}

/* ===== TASK INFO ===== */
.task-info {
  margin-top: 12px;
  font-size: 13px;
  color: var(--text-dim);
  text-align: center;
}

.task-info .task-id {
  color: var(--accent);
  font-weight: 600;
  font-size: 15px;
}

/* ===== RIGHT PANEL ===== */
.right-panel {
  width: 480px;
  min-width: 400px;
  display: flex;
  flex-direction: column;
  padding: 20px;
  overflow-y: auto;
  gap: 16px;
}

/* ===== AI SUGGESTION PANEL ===== */
.ai-suggestion {
  background: var(--accent-dim);
  border: 1px solid var(--border-accent);
  border-left: 3px solid var(--accent);
  border-radius: var(--radius-md);
  padding: 14px 16px;
}

.ai-suggestion .label {
  font-size: 11px;
  color: var(--text-dim);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  font-weight: 600;
}

.ai-suggestion .path {
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  color: var(--text);
  word-break: break-word;
  line-height: 1.6;
  padding: 4px 0;
}

.ai-suggestion .path.valid { color: var(--accent); font-weight: 500; }
.ai-suggestion .path.invalid { color: var(--red); font-style: italic; }

.ai-suggestion .ai-badge {
  display: inline-block;
  background: rgba(232, 168, 72, 0.15);
  color: var(--accent);
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 10px;
  margin-top: 8px;
  font-weight: 600;
  letter-spacing: 0.05em;
}

/* ===== HUMAN REFERENCE ===== */
.human-ref {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-left: 3px solid var(--green);
  border-radius: var(--radius-md);
  padding: 12px 16px;
  font-size: 13px;
  color: var(--text-dim);
  display: none;
  line-height: 1.6;
}

.human-ref .path {
  color: var(--green);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  font-weight: 500;
}

/* ===== LEVEL SELECTORS ===== */
.selector-section {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.level-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

.level-label {
  width: 28px;
  font-size: 12px;
  font-weight: 700;
  color: var(--accent);
  flex-shrink: 0;
}

.level-select-wrapper {
  flex: 1;
  position: relative;
}

.level-select-wrapper select {
  width: 100%;
  background: var(--surface2);
  color: var(--text);
  color-scheme: dark;
  border: 1px solid var(--border);
  padding: 8px 12px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  cursor: pointer;
  transition: var(--transition);
  appearance: auto;
}

.level-select-wrapper select:disabled {
  opacity: 0.35;
  cursor: not-allowed;
}

.level-select-wrapper select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-dim);
  outline: none;
}

.level-select-wrapper select.user-selected {
  border-color: var(--accent);
  background: var(--accent-dim);
}

.level-select-wrapper select option {
  background: var(--surface2);
  color: var(--text);
}

/* ===== SEARCH BOX FOR L3+ ===== */
.level-search {
  position: relative;
  flex: 1;
  display: none;
}

.level-search input {
  width: 100%;
  background: var(--surface2);
  color: var(--text);
  border: 1px solid var(--border);
  padding: 7px 12px;
  border-radius: var(--radius-sm);
  font-size: 12px;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  transition: var(--transition);
}

.level-search input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-dim);
  outline: none;
}

.level-search .search-results {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: var(--surface);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 0 0 var(--radius-sm) var(--radius-sm);
  max-height: 200px;
  overflow-y: auto;
  z-index: 100;
  display: none;
  box-shadow: var(--shadow-md);
}

.level-search .search-results .result-item {
  padding: 8px 12px;
  font-size: 12px;
  cursor: pointer;
  border-bottom: 1px solid var(--border);
  transition: var(--transition);
  color: var(--text);
}

.level-search .search-results .result-item:hover {
  background: var(--accent);
  color: #000;
}

/* ===== FULL PATH DISPLAY ===== */
.full-path-display {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-left: 3px solid var(--accent);
  border-radius: var(--radius-md);
  padding: 12px 16px;
  font-size: 13px;
  min-height: 44px;
  flex-shrink: 0;
}

.full-path-display .label {
  font-size: 11px;
  color: var(--text-dim);
  margin-bottom: 6px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.full-path-display .path {
  color: var(--accent);
  font-weight: 600;
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  line-height: 1.5;
  white-space: normal;
  overflow-wrap: anywhere;
  word-break: break-word;
  padding: 2px 0;
}

/* ===== ACTION BUTTONS ===== */
.action-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.action-buttons button {
  flex: 1;
  min-width: 80px;
  padding: 10px 14px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 600;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  cursor: pointer;
  transition: var(--transition);
  background: var(--surface2);
  color: var(--text);
  position: relative;
  overflow: hidden;
}

.action-buttons button:hover {
  border-color: var(--accent);
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
}

.action-buttons button.active-accept {
  background: linear-gradient(135deg, #34d399, #059669);
  color: #fff;
  border-color: transparent;
  box-shadow: 0 0 16px rgba(52,211,153,0.25);
}

.action-buttons button.active-modify {
  background: linear-gradient(135deg, var(--accent), #d4941c);
  color: #000;
  border-color: transparent;
  box-shadow: 0 0 16px var(--accent-glow);
}

.action-buttons button.active-override {
  background: linear-gradient(135deg, #fb7185, #e11d48);
  color: #fff;
  border-color: transparent;
  box-shadow: 0 0 16px rgba(251,113,133,0.25);
}

.action-buttons button.btn-uncertain {
  background: var(--surface2);
  color: var(--orange);
  border-color: rgba(251,146,60,0.3);
}

.action-buttons button.btn-uncertain:hover {
  border-color: var(--orange);
  background: rgba(251,146,60,0.08);
}

.action-buttons button.active-uncertain {
  background: linear-gradient(135deg, #fbbf24, #d97706);
  color: #000;
  border-color: transparent;
  box-shadow: 0 0 16px rgba(251,191,36,0.3);
}

/* ===== NOTE INPUT ===== */
.note-section {
  display: flex;
  align-items: center;
  gap: 8px;
}

.note-section label {
  font-size: 12px;
  color: var(--text-dim);
  flex-shrink: 0;
  font-weight: 600;
}

.note-section input, .note-section textarea {
  flex: 1;
  background: rgba(255,255,255,0.04);
  color: var(--text);
  border: 1px solid rgba(255,255,255,0.08);
  padding: 8px 12px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  transition: var(--transition);
}

.note-section textarea {
  resize: vertical;
  min-height: 40px;
}

.note-section input:focus, .note-section textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-dim);
  outline: none;
}

/* ===== NAVIGATION BUTTONS ===== */
.nav-buttons {
  display: flex;
  gap: 8px;
  margin-top: auto;
  padding-top: 8px;
}

.nav-buttons button {
  padding: 10px 20px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 600;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  cursor: pointer;
  background: var(--surface2);
  color: var(--text);
  transition: var(--transition);
}

.nav-buttons button:hover {
  border-color: var(--accent);
  color: var(--accent);
  transform: translateY(-1px);
}

.nav-buttons button.btn-primary {
  background: linear-gradient(135deg, var(--accent), #d4941c);
  color: #000;
  border-color: transparent;
  font-weight: 700;
  box-shadow: 0 2px 12px var(--accent-glow);
}

.nav-buttons button.btn-primary:hover {
  box-shadow: 0 4px 20px var(--accent-glow);
  transform: translateY(-1px);
  color: #000;
}

.nav-buttons button.btn-export {
  background: linear-gradient(135deg, #34d399, #059669);
  color: #fff;
  border-color: transparent;
}

.nav-buttons button.btn-export:hover {
  box-shadow: 0 4px 16px rgba(52,211,153,0.25);
  transform: translateY(-1px);
  color: #fff;
}

.nav-buttons button:disabled {
  opacity: 0.35;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* ===== BOTTOM BAR ===== */
.bottom-bar {
  background: rgba(20, 19, 26, 0.9);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-top: 1px solid var(--border);
  padding: 10px 24px;
  display: flex;
  align-items: center;
  gap: 16px;
}

/* ===== PROGRESS BAR ===== */
.progress-bar-track {
  flex: 1;
  height: 6px;
  background: var(--surface3);
  border-radius: 3px;
  overflow: hidden;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--green));
  border-radius: 3px;
  transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 0 8px var(--accent-glow);
}

/* ===== STATS ===== */
.stats {
  font-size: 12px;
  color: var(--text-dim);
  white-space: nowrap;
}

.stats span { margin: 0 4px; }
.stats .labeled { color: var(--green); font-weight: 600; }
.stats .uncertain { color: var(--orange); font-weight: 600; }
.stats .remaining { color: var(--text-dim); }

/* ===== UPLOAD FALLBACK ===== */
.upload-fallback {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--bg);
  z-index: 1000;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 24px;
  padding: 40px;
}

.upload-fallback h2 {
  color: var(--accent);
  font-size: 24px;
  font-weight: 700;
  letter-spacing: -0.02em;
}

.upload-fallback p {
  color: var(--text-dim);
  font-size: 14px;
  text-align: center;
  max-width: 500px;
  line-height: 1.6;
}

.upload-fallback .upload-group {
  display: flex;
  flex-direction: column;
  gap: 12px;
  width: 100%;
  max-width: 500px;
}

.upload-fallback .upload-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 20px;
  transition: var(--transition);
}

.upload-fallback .upload-item:hover {
  border-color: var(--border-accent);
}

.upload-fallback .upload-item label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 8px;
}

.upload-fallback .upload-item input[type="file"] {
  font-size: 13px;
  color: var(--text-dim);
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
}

.upload-fallback .upload-item .status {
  font-size: 12px;
  margin-top: 6px;
}

.upload-fallback .upload-item .status.loaded { color: var(--green); }
.upload-fallback .upload-item .status.missing { color: var(--orange); }

.upload-fallback button.start-btn {
  background: linear-gradient(135deg, var(--accent), #d4941c);
  color: #000;
  border: none;
  padding: 14px 36px;
  border-radius: var(--radius-sm);
  font-size: 15px;
  font-weight: 700;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  cursor: pointer;
  box-shadow: 0 2px 16px var(--accent-glow);
  transition: var(--transition);
  margin-top: 10px;
}

.upload-fallback button.start-btn:hover {
  box-shadow: 0 4px 24px var(--accent-glow);
  transform: translateY(-1px);
}

.upload-fallback button.start-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* ===== UNCERTAIN MODAL ===== */
.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  z-index: 500;
  display: none;
  align-items: center;
  justify-content: center;
}

.modal-overlay.active { display: flex; }

.modal {
  background: var(--surface);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--radius-lg);
  padding: 28px;
  width: 420px;
  max-width: 90%;
  box-shadow: var(--shadow-lg);
  animation: modalIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

.modal h3 {
  color: var(--orange);
  margin-bottom: 12px;
  font-size: 16px;
  font-weight: 700;
}

.modal p {
  font-size: 13px;
  color: var(--text-dim);
  margin-bottom: 10px;
  line-height: 1.5;
}

.modal textarea {
  width: 100%;
  background: rgba(255,255,255,0.04);
  color: var(--text);
  border: 1px solid rgba(255,255,255,0.08);
  padding: 12px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  min-height: 80px;
  resize: vertical;
  transition: var(--transition);
}

.modal textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-dim);
  outline: none;
}

.modal .modal-actions {
  display: flex;
  gap: 8px;
  margin-top: 16px;
  justify-content: flex-end;
}

.modal .modal-actions button {
  padding: 9px 20px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  transition: var(--transition);
}

.modal .modal-actions .btn-cancel {
  background: var(--surface2);
  color: var(--text);
}

.modal .modal-actions .btn-cancel:hover {
  border-color: rgba(255,255,255,0.15);
}

.modal .modal-actions .btn-confirm {
  background: linear-gradient(135deg, var(--orange), #ea580c);
  color: #000;
  border-color: transparent;
}

.modal .modal-actions .btn-confirm:hover {
  box-shadow: 0 2px 12px rgba(251,146,60,0.3);
  transform: translateY(-1px);
}

.modal .modal-actions .btn-confirm:disabled {
  opacity: 0.3;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* ===== KEYBOARD HINTS ===== */
.keyboard-hints {
  font-size: 11px;
  color: var(--text-dim);
  display: flex;
  gap: 14px;
  flex-wrap: wrap;
  padding: 8px 0;
}

.keyboard-hints kbd {
  background: var(--surface3);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 2px 7px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  color: var(--text-dim);
}

/* ===== ACTIVE DROPDOWN INDICATOR ===== */
.level-row.active-level .level-label {
  color: var(--yellow);
  text-shadow: 0 0 8px rgba(253,230,138,0.3);
}

/* ===== TOAST NOTIFICATION ===== */
.toast {
  position: fixed;
  top: 24px;
  right: 24px;
  background: rgba(20, 19, 26, 0.92);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 1px solid var(--border-accent);
  color: var(--text);
  padding: 14px 24px;
  border-radius: var(--radius-md);
  font-size: 13px;
  font-weight: 500;
  z-index: 600;
  opacity: 0;
  transform: translateX(20px);
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  pointer-events: none;
  box-shadow: var(--shadow-md);
}

.toast.show {
  opacity: 1;
  transform: translateX(0);
}

/* ===== LOGIN OVERLAY ===== */
.login-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: #0c0b10;
  z-index: 2000;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

/* Animated background mesh */
.login-overlay::before {
  content: '';
  position: absolute;
  top: -50%; left: -50%;
  width: 200%; height: 200%;
  background:
    radial-gradient(ellipse at 20% 50%, rgba(232, 168, 72, 0.08) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 20%, rgba(168, 85, 247, 0.06) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 80%, rgba(52, 211, 153, 0.05) 0%, transparent 50%);
  animation: meshRotate 20s linear infinite;
}

.login-mosaic {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  display: grid; grid-template-columns: repeat(8, 1fr); grid-auto-rows: 1fr;
  gap: 3px; opacity: 0.15; pointer-events: none;
}
.login-mosaic img { width: 100%; height: 100%; object-fit: cover; display: block; }

@keyframes meshRotate {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ===== LOGIN MODAL ===== */
.login-modal {
  background: rgba(20, 19, 26, 0.8);
  backdrop-filter: blur(24px);
  -webkit-backdrop-filter: blur(24px);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--radius-lg);
  padding: 48px 44px;
  width: 440px;
  max-width: 90%;
  text-align: center;
  box-shadow: var(--shadow-lg);
  position: relative;
  z-index: 1;
  animation: modalIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes modalIn {
  0% { opacity: 0; transform: translateY(20px) scale(0.96); }
  100% { opacity: 1; transform: translateY(0) scale(1); }
}

.login-modal h2 {
  color: var(--accent);
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 28px;
  letter-spacing: -0.02em;
}

.login-modal .login-field {
  text-align: left;
  margin-bottom: 18px;
}

.login-modal .login-field label {
  display: block;
  font-size: 12px;
  color: var(--text-dim);
  margin-bottom: 8px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.login-modal .login-field input,
.login-modal .login-field select {
  width: 100%;
  background: rgba(255,255,255,0.04);
  color: var(--text);
  color-scheme: dark;
  border: 1px solid rgba(255,255,255,0.08);
  padding: 12px 16px;
  border-radius: var(--radius-sm);
  font-size: 14px;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  transition: var(--transition);
  outline: none;
}

.login-modal .login-field input:focus,
.login-modal .login-field select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-dim);
}

.login-modal .login-field select option {
  background: var(--surface2);
  color: var(--text);
}

.login-modal .login-note {
  font-size: 12px;
  color: var(--text-dim);
  margin-bottom: 20px;
  line-height: 1.6;
  text-align: left;
}

.login-modal .login-start-btn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, var(--accent), #d4941c);
  color: #000;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 15px;
  font-weight: 700;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  cursor: pointer;
  transition: var(--transition);
  box-shadow: 0 2px 16px var(--accent-glow);
  margin-top: 8px;
}

.login-modal .login-start-btn:hover {
  box-shadow: 0 4px 24px var(--accent-glow);
  transform: translateY(-1px);
}

.login-modal .login-start-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* ===== SWITCH USER BUTTON ===== */
.switch-user-btn {
  background: none;
  border: 1px solid rgba(255,255,255,0.08);
  color: var(--text-dim);
  font-size: 11px;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
  padding: 4px 10px;
  border-radius: 20px;
  cursor: pointer;
  transition: var(--transition);
}

.switch-user-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
}

/* ===== ANNOTATOR DISPLAY ===== */
#annotatorDisplay {
  font-size: 13px;
  color: var(--accent);
  font-weight: 600;
  font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
}
</style>
</head>
<body>

<!-- Login Modal -->
<div class="login-overlay" id="loginOverlay" style="display:none;">
  <div class="login-mosaic">
    <img src="../assets/mosaic/m03.jpg" alt=""><img src="../assets/mosaic/m04.jpg" alt=""><img src="../assets/mosaic/m05.jpg" alt=""><img src="../assets/mosaic/m06.jpg" alt=""><img src="../assets/mosaic/m10.jpg" alt=""><img src="../assets/mosaic/m11.jpg" alt=""><img src="../assets/mosaic/m13.jpg" alt=""><img src="../assets/mosaic/m14.jpg" alt="">
    <img src="../assets/mosaic/m16.jpg" alt=""><img src="../assets/mosaic/m17.jpg" alt=""><img src="../assets/mosaic/m18.jpg" alt=""><img src="../assets/mosaic/m20.jpg" alt=""><img src="../assets/mosaic/m21.jpg" alt=""><img src="../assets/mosaic/m22.jpg" alt=""><img src="../assets/mosaic/m27.jpg" alt=""><img src="../assets/mosaic/m29.jpg" alt="">
    <img src="../assets/mosaic/m31.jpg" alt=""><img src="../assets/mosaic/m33.jpg" alt=""><img src="../assets/mosaic/m35.jpg" alt=""><img src="../assets/mosaic/m36.jpg" alt=""><img src="../assets/mosaic/m40.jpg" alt=""><img src="../assets/mosaic/m41.jpg" alt=""><img src="../assets/mosaic/m42.jpg" alt=""><img src="../assets/mosaic/m43.jpg" alt="">
    <img src="../assets/mosaic/m44.jpg" alt=""><img src="../assets/mosaic/m45.jpg" alt=""><img src="../assets/mosaic/m46.jpg" alt=""><img src="../assets/mosaic/m47.jpg" alt=""><img src="../assets/mosaic/m48.jpg" alt=""><img src="../assets/mosaic/m50.jpg" alt=""><img src="../assets/mosaic/m51.jpg" alt=""><img src="../assets/mosaic/m54.jpg" alt="">
    <img src="../assets/mosaic/m55.jpg" alt=""><img src="../assets/mosaic/m56.jpg" alt="">
  </div>
  <div class="login-modal">
    <h2>Welcome to Image Annotation Tool</h2>
    <div class="login-field">
      <label for="loginName">Your Name</label>
      <input type="text" id="loginName" placeholder="Enter your name..." required>
    </div>
    <div class="login-field">
      <label for="loginGroup">Annotator Group</label>
      <select id="loginGroup">
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
        <option value="D">D</option>
        <option value="E">E</option>
      </select>
    </div>
    <div class="login-note">Your group determines which images are assigned to you.</div>
    <button class="login-start-btn" id="loginStartBtn" disabled>Start</button>
  </div>
</div>

<!-- Upload Fallback -->
<div class="upload-fallback" id="uploadFallback" style="display:none;">
  <h2>Image Annotation Tool v1.0</h2>
  <p>Data files not auto-loaded. Please upload the required files below to get started.</p>
  <div class="upload-group">
    <div class="upload-item">
      <label>Taxonomy JSON (visual_elements_global.json)</label>
      <input type="file" accept=".json,.js" id="uploadTaxonomy">
      <div class="status" id="statusTaxonomy">
        <span class="missing">Not loaded</span>
      </div>
    </div>
    <div class="upload-item">
      <label>Tasks CSV (annotation_tasks_780.csv or annotation_tasks_1000.csv)</label>
      <input type="file" accept=".csv" id="uploadTasks" multiple>
      <div class="status" id="statusTasks">
        <span class="missing">Not loaded</span>
      </div>
    </div>
    <div class="upload-item">
      <label>Assignment Manifest (assignment_manifest.csv) - optional</label>
      <input type="file" accept=".csv" id="uploadManifest">
      <div class="status" id="statusManifest">
        <span class="missing">Not loaded (will show all tasks)</span>
      </div>
    </div>
  </div>
  <button class="start-btn" id="startBtn" disabled>Start Annotation</button>
</div>

<!-- Main UI -->
<div class="top-bar" id="topBar">
  <span class="title">Image Annotation Tool v1.0</span>
  <div class="controls">
    <label>Annotator:</label>
    <span id="annotatorDisplay">--</span>
    <button class="switch-user-btn" id="switchUserBtn">Switch User</button>
    <label>Batch:</label>
    <select id="batchSelect">
      <option value="780">780</option>
      <option value="1000">1000</option>
    </select>
    <span class="progress-text" id="progressText">
      <span id="currentIdx">0</span> / <span id="totalCount">0</span>
    </span>
  </div>
</div>
<div class="taxonomy-link">
  View Taxonomy Tree: <a href="https://rajeshzheng.github.io/ls-taxonomy-v2_202602/" target="_blank">https://rajeshzheng.github.io/ls-taxonomy-v2_202602/</a>
</div>

<div class="main-content" id="mainContent">
  <!-- Left Panel -->
  <div class="left-panel">
    <div class="image-container" id="imageContainer">
      <div class="placeholder" id="imagePlaceholder">Select an annotator and batch to begin</div>
      <div class="image-loading" id="imageLoading"><div class="spinner"></div><span>Loading...</span></div>
      <img id="taskImage" style="display:none;" alt="Task image">
    </div>
    <div class="task-info" id="taskInfo">
      <span class="task-id" id="taskIdDisplay">--</span>
      <span id="taskSourceDisplay"></span>
    </div>
  </div>

  <!-- Right Panel -->
  <div class="right-panel" id="rightPanel">
    <div class="ai-suggestion" id="aiSuggestion">
      <div class="label">AI Suggestion</div>
      <div class="path" id="aiPathDisplay">--</div>
      <span class="ai-badge" id="aiBadge">AI</span>
    </div>

    <div class="human-ref" id="humanRef">
      <span style="color:var(--text-dim)">Human Reference (780): </span>
      <span class="path" id="humanRefPath">--</span>
    </div>

    <!-- Level Selectors -->
    <div class="selector-section" id="selectorSection">
      <div class="level-row" data-level="1" id="levelRow1">
        <span class="level-label">L1</span>
        <div class="level-select-wrapper">
          <select id="selectL1"><option value="">-- Select L1 --</option></select>
        </div>
      </div>
      <div class="level-row" data-level="2" id="levelRow2">
        <span class="level-label">L2</span>
        <div class="level-select-wrapper">
          <select id="selectL2" disabled><option value="">-- Select L2 --</option></select>
        </div>
      </div>
      <div class="level-row" data-level="3" id="levelRow3">
        <span class="level-label">L3</span>
        <div class="level-select-wrapper">
          <select id="selectL3" disabled><option value="">-- Select L3 --</option></select>
        </div>
        <div class="level-search" id="searchL3">
          <input type="text" placeholder="Search L3..." id="searchInputL3">
          <div class="search-results" id="searchResultsL3"></div>
        </div>
      </div>
      <div class="level-row" data-level="4" id="levelRow4">
        <span class="level-label">L4</span>
        <div class="level-select-wrapper">
          <select id="selectL4" disabled><option value="">-- Select L4 --</option></select>
        </div>
        <div class="level-search" id="searchL4">
          <input type="text" placeholder="Search L4..." id="searchInputL4">
          <div class="search-results" id="searchResultsL4"></div>
        </div>
      </div>
      <div class="level-row" data-level="5" id="levelRow5">
        <span class="level-label">L5</span>
        <div class="level-select-wrapper">
          <select id="selectL5" disabled><option value="">-- Select L5 --</option></select>
        </div>
        <div class="level-search" id="searchL5">
          <input type="text" placeholder="Search L5..." id="searchInputL5">
          <div class="search-results" id="searchResultsL5"></div>
        </div>
      </div>
    </div>

    <!-- Full path -->
    <div class="full-path-display">
      <div class="label">Selected Path</div>
      <div class="path" id="fullPathDisplay">--</div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons" id="actionButtons">
      <button id="btnAccept" title="Accept AI suggestion (A)">Accept</button>
      <button id="btnModify" title="Modify AI suggestion">Modify</button>
      <button id="btnReselect" title="Completely reselect">Reselect</button>
      <button id="btnUncertain" class="btn-uncertain" title="Mark as uncertain (U)">Uncertain</button>
    </div>

    <!-- Note -->
    <div class="note-section">
      <label>Note:</label>
      <input type="text" id="noteInput" placeholder="Optional note...">
    </div>

    <!-- Keyboard hints -->
    <div class="keyboard-hints">
      <span><kbd>Enter</kbd> Confirm</span>
      <span><kbd>&larr;</kbd><kbd>&rarr;</kbd> Navigate</span>
      <span><kbd>A</kbd> Accept</span>
      <span><kbd>U</kbd> Uncertain</span>
      <span><kbd>1</kbd>-<kbd>9</kbd> Quick select</span>
    </div>

    <!-- Nav Buttons -->
    <div class="nav-buttons">
      <button id="btnPrev" title="Previous (Left arrow)">&larr; Prev</button>
      <button id="btnConfirm" class="btn-primary" title="Confirm & Next (Enter)">Confirm & Next &rarr;</button>
      <button id="btnExport" class="btn-export" title="Export CSV">Export CSV</button>
    </div>
  </div>
</div>

<!-- Bottom Bar -->
<div class="bottom-bar" id="bottomBar">
  <div class="progress-bar-track">
    <div class="progress-bar-fill" id="progressBarFill" style="width:0%"></div>
  </div>
  <div class="stats">
    <span id="statsText">Labeled: 0 | Uncertain: 0 | Left: 0</span>
  </div>
</div>

<!-- Uncertain Modal -->
<div class="modal-overlay" id="uncertainModal">
  <div class="modal">
    <h3>Mark as Uncertain</h3>
    <p style="font-size:13px;color:var(--text-dim);margin-bottom:10px;">Please provide a reason for marking this item as uncertain. A reason is required.</p>
    <textarea id="uncertainReason" placeholder="Enter reason..."></textarea>
    <div class="modal-actions">
      <button class="btn-cancel" id="uncertainCancel">Cancel</button>
      <button class="btn-confirm" id="uncertainConfirm" disabled>Confirm Uncertain</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
(function() {
  'use strict';

  // ========== STATE ==========
  let taxonomyData = null;
  let tasks780 = [];
  let tasks1000 = [];
  let manifestData = [];
  let currentTasks = [];
  let currentIndex = 0;
  let annotations = {};
  let annotatorId = '';
  let annotatorName = '';
  let batchId = '780';
  let startTime = 0;
  let activeLevel = null;
  let dataReady = false;
  let currentAction = '';

  // ========== CSV PARSER ==========
  function parseCSV(csvStr) {
    if (!csvStr || !csvStr.trim()) return [];
    const lines = csvStr.trim().replace(/^\ufeff/, '').split('\n');
    if (lines.length < 2) return [];
    const headers = parseCSVLine(lines[0]);
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const vals = parseCSVLine(lines[i]);
      if (vals.length === 0 || (vals.length === 1 && vals[0] === '')) continue;
      const obj = {};
      for (let j = 0; j < headers.length; j++) {
        obj[headers[j].trim()] = (vals[j] || '').trim();
      }
      rows.push(obj);
    }
    return rows;
  }

  function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const c = line[i];
      if (inQuotes) {
        if (c === '"') {
          if (i + 1 < line.length && line[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = false;
          }
        } else {
          current += c;
        }
      } else {
        if (c === '"') {
          inQuotes = true;
        } else if (c === ',') {
          result.push(current);
          current = '';
        } else {
          current += c;
        }
      }
    }
    result.push(current);
    return result;
  }

  // ========== TAXONOMY ==========
  let l1Nodes = [];
  let nodeMap = {};

  function buildTreeIndex(tree) {
    if (!tree || !tree.children) return;
    l1Nodes = [];
    nodeMap = {};

    function walk(node, depth, parentPath, parentPathEn) {
      const zhName = node.name || '';
      const enName = node.name_en || '';
      const path = parentPath ? parentPath + '/' + zhName : zhName;
      const pathEn = parentPathEn ? parentPathEn + '/' + enName : enName;
      const entry = {
        name: zhName,
        name_en: enName,
        path: path,
        path_en: pathEn,
        depth: depth,
        children: []
      };
      nodeMap[path] = entry;
      if (node.children && node.children.length > 0) {
        for (const child of node.children) {
          const childEntry = walk(child, depth + 1, path, pathEn);
          entry.children.push(childEntry);
        }
        entry.children.sort((a, b) => (a.name_en || '').localeCompare(b.name_en || ''));
      }
      return entry;
    }

    for (const child of tree.children) {
      const entry = walk(child, 1, '', '');
      l1Nodes.push(entry);
    }
    l1Nodes.sort((a, b) => (a.name_en || '').localeCompare(b.name_en || ''));
  }

  function populateSelect(selectEl, nodes, placeholder) {
    selectEl.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = placeholder || '-- Select --';
    selectEl.appendChild(opt0);
    selectEl.classList.remove('user-selected');
    if (!nodes) return;
    for (const node of nodes) {
      const opt = document.createElement('option');
      opt.value = node.path;
      opt.textContent = (node.name_en || '') + ' (' + (node.name || '') + ')';
      opt.dataset.name = node.name;
      opt.dataset.nameEn = node.name_en;
      selectEl.appendChild(opt);
    }
    selectEl.disabled = false;
  }

  function disableSelectsFrom(level) {
    for (let i = level; i <= 5; i++) {
      const sel = document.getElementById('selectL' + i);
      sel.innerHTML = '<option value="">--- N/A ---</option>';
      sel.disabled = true;
      sel.classList.remove('user-selected');
      const search = document.getElementById('searchL' + i);
      if (search) search.style.display = 'none';
    }
  }

  function onLevelChange(level) {
    const sel = document.getElementById('selectL' + level);
    const path = sel.value;
    disableSelectsFrom(level + 1);

    if (!path) {
      sel.classList.remove('user-selected');
      updateFullPath();
      updateActionState();
      return;
    }

    sel.classList.add('user-selected');
    const node = nodeMap[path];
    if (node && node.children && node.children.length > 0) {
      const nextLevel = level + 1;
      if (nextLevel <= 5) {
        const nextSel = document.getElementById('selectL' + nextLevel);
        populateSelect(nextSel, node.children, '-- Select L' + nextLevel + ' --');
        if (nextLevel >= 3) {
          const searchDiv = document.getElementById('searchL' + nextLevel);
          if (searchDiv) searchDiv.style.display = 'block';
        }
        setActiveLevel(nextLevel);
      }
    }
    updateFullPath();
    updateActionState();
  }

  function setActiveLevel(level) {
    activeLevel = level;
    for (let i = 1; i <= 5; i++) {
      const row = document.getElementById('levelRow' + i);
      row.classList.toggle('active-level', i === level);
    }
  }

  function getSelectedPath() {
    let path = '';
    let pathEn = '';
    for (let i = 1; i <= 5; i++) {
      const sel = document.getElementById('selectL' + i);
      if (sel.disabled || !sel.value) break;
      const selectedOpt = sel.options[sel.selectedIndex];
      const zhName = selectedOpt ? selectedOpt.dataset.name || '' : '';
      const enName = selectedOpt ? selectedOpt.dataset.nameEn || '' : '';
      path += (path ? '/' : '') + zhName;
      pathEn += (pathEn ? '/' : '') + enName;
    }
    return { path, pathEn };
  }

  function getSelectedLevels() {
    const levels = {};
    for (let i = 1; i <= 5; i++) {
      const sel = document.getElementById('selectL' + i);
      if (sel.disabled || !sel.value) break;
      const selectedOpt = sel.options[sel.selectedIndex];
      levels['L' + i] = selectedOpt ? selectedOpt.dataset.name || '' : '';
      levels['L' + i + '_en'] = selectedOpt ? selectedOpt.dataset.nameEn || '' : '';
    }
    return levels;
  }

  function updateFullPath() {
    const { path, pathEn } = getSelectedPath();
    const display = document.getElementById('fullPathDisplay');
    if (path) {
      display.textContent = pathEn + ' (' + path + ')';
    } else {
      display.textContent = '--';
    }
  }

  function setSelectorsFromPath(zhPath) {
    if (!zhPath) return;
    const parts = zhPath.split('/');
    let currentPath = '';
    for (let i = 0; i < parts.length && i < 5; i++) {
      currentPath += (currentPath ? '/' : '') + parts[i];
      const level = i + 1;
      const sel = document.getElementById('selectL' + level);
      if (sel.disabled) break;

      // Find matching option
      let found = false;
      for (let j = 0; j < sel.options.length; j++) {
        if (sel.options[j].value === currentPath) {
          sel.selectedIndex = j;
          sel.classList.add('user-selected');
          found = true;
          break;
        }
      }
      if (!found) break;

      // Populate next level
      const node = nodeMap[currentPath];
      if (node && node.children && node.children.length > 0) {
        const nextLevel = level + 1;
        if (nextLevel <= 5) {
          const nextSel = document.getElementById('selectL' + nextLevel);
          populateSelect(nextSel, node.children, '-- Select L' + nextLevel + ' --');
          if (nextLevel >= 3) {
            const searchDiv = document.getElementById('searchL' + nextLevel);
            if (searchDiv) searchDiv.style.display = 'block';
          }
        }
      }
    }
    updateFullPath();
  }

  // ========== SEARCH ==========
  function setupSearch(level) {
    const input = document.getElementById('searchInputL' + level);
    const results = document.getElementById('searchResultsL' + level);
    if (!input || !results) return;

    input.addEventListener('input', function() {
      const query = this.value.toLowerCase().trim();
      results.innerHTML = '';
      if (!query) {
        results.style.display = 'none';
        return;
      }
      const sel = document.getElementById('selectL' + level);
      const matches = [];
      for (let i = 1; i < sel.options.length; i++) {
        const opt = sel.options[i];
        const text = opt.textContent.toLowerCase();
        if (text.includes(query)) {
          matches.push({ index: i, text: opt.textContent, value: opt.value });
        }
      }
      if (matches.length === 0) {
        results.style.display = 'none';
        return;
      }
      results.style.display = 'block';
      for (const m of matches.slice(0, 20)) {
        const div = document.createElement('div');
        div.className = 'result-item';
        div.textContent = m.text;
        div.addEventListener('click', function() {
          sel.selectedIndex = m.index;
          onLevelChange(level);
          input.value = '';
          results.style.display = 'none';
        });
        results.appendChild(div);
      }
    });

    input.addEventListener('blur', function() {
      setTimeout(() => { results.style.display = 'none'; }, 200);
    });
  }

  // ========== AI ACTION ==========
  function determineAiAction(currentPath, aiPath) {
    if (!aiPath || !aiPath.trim()) return 'OVERRIDE';
    if (currentPath === aiPath) return 'ACCEPT';
    const cParts = currentPath.split('/');
    const aParts = aiPath.split('/');
    let shared = 0;
    for (let i = 0; i < Math.min(cParts.length, aParts.length); i++) {
      if (cParts[i] === aParts[i]) shared++;
      else break;
    }
    return shared >= 1 ? 'MODIFY' : 'OVERRIDE';
  }

  function updateActionState() {
    const task = currentTasks[currentIndex];
    if (!task) return;
    const { path } = getSelectedPath();
    const aiPath = task.ai_path || '';

    // Clear active states
    document.getElementById('btnAccept').className = '';
    document.getElementById('btnModify').className = '';
    document.getElementById('btnReselect').className = '';
    document.getElementById('btnUncertain').className = 'btn-uncertain';

    if (currentAction === 'UNCERTAIN') {
      document.getElementById('btnUncertain').className = 'btn-uncertain active-uncertain';
      return;
    }

    if (!path) return;

    const action = determineAiAction(path, aiPath);
    currentAction = action;
    if (action === 'ACCEPT') {
      document.getElementById('btnAccept').className = 'active-accept';
    } else if (action === 'MODIFY') {
      document.getElementById('btnModify').className = 'active-modify';
    } else {
      document.getElementById('btnReselect').className = 'active-override';
    }
  }

  // ========== TASK LOADING ==========
  function loadTask(index) {
    if (!currentTasks.length) return;
    if (index < 0) index = 0;
    if (index >= currentTasks.length) index = currentTasks.length - 1;
    currentIndex = index;
    startTime = Date.now();
    currentAction = '';

    const task = currentTasks[index];
    document.getElementById('currentIdx').textContent = index + 1;
    document.getElementById('totalCount').textContent = currentTasks.length;

    // Image
    const img = document.getElementById('taskImage');
    const placeholder = document.getElementById('imagePlaceholder');
    const loading = document.getElementById('imageLoading');
    if (task.upload_url) {
      img.style.display = 'none';
      placeholder.style.display = 'none';
      loading.classList.add('active');
      img.onload = function() {
        loading.classList.remove('active');
        img.style.display = 'block';
      };
      img.onerror = function() {
        loading.classList.remove('active');
        img.style.display = 'none';
        placeholder.style.display = 'block';
        placeholder.textContent = 'Failed to load image: ' + task.upload_url;
      };
      img.src = task.upload_url;
    } else {
      loading.classList.remove('active');
      img.style.display = 'none';
      placeholder.style.display = 'block';
      placeholder.textContent = 'No image URL';
    }

    // Task info
    document.getElementById('taskIdDisplay').textContent = task.task_id || '--';
    document.getElementById('taskSourceDisplay').textContent = task.source ? ' | source: ' + task.source : '';

    // AI suggestion
    const aiDisplay = document.getElementById('aiPathDisplay');
    if (task.ai_valid === 'true' && task.ai_path) {
      aiDisplay.textContent = (task.ai_path_en || '') + ' (' + (task.ai_path || '') + ')';
      aiDisplay.className = 'path valid';
    } else if (task.ai_path) {
      aiDisplay.textContent = (task.ai_path_en || task.ai_path) + ' (invalid in V2)';
      aiDisplay.className = 'path invalid';
    } else {
      aiDisplay.textContent = 'No AI prediction available';
      aiDisplay.className = 'path';
    }

    // Human reference
    const humanRefDiv = document.getElementById('humanRef');
    if (task.has_human_ref === 'true' && task.human_ref_path) {
      humanRefDiv.style.display = 'block';
      document.getElementById('humanRefPath').textContent = task.human_ref_path;
    } else {
      humanRefDiv.style.display = 'none';
    }

    // Reset selectors
    resetSelectors();

    // Load previous annotation if exists
    const saved = annotations[task.task_id];
    if (saved) {
      if (saved.label_path) {
        setSelectorsFromPath(saved.label_path);
      }
      currentAction = saved.ai_action || '';
      document.getElementById('noteInput').value = saved.uncertain_reason || saved.note || '';
      updateActionState();
      if (saved.ai_action === 'UNCERTAIN') {
        currentAction = 'UNCERTAIN';
        document.getElementById('btnUncertain').className = 'btn-uncertain active-uncertain';
      }
    } else {
      document.getElementById('noteInput').value = '';
    }

    updateStats();
    updateProgressBar();
  }

  function resetSelectors() {
    populateSelect(document.getElementById('selectL1'), l1Nodes, '-- Select L1 --');
    disableSelectsFrom(2);
    setActiveLevel(1);
    document.getElementById('selectL1').classList.remove('user-selected');
    updateFullPath();
    currentAction = '';
    updateActionState();
  }

  // ========== ANNOTATIONS ==========
  function saveAnnotation() {
    const task = currentTasks[currentIndex];
    if (!task) return false;

    const { path, pathEn } = getSelectedPath();
    const levels = getSelectedLevels();

    if (currentAction === 'UNCERTAIN') {
      const reason = document.getElementById('noteInput').value.trim();
      if (!reason) {
        showToast('Please provide a reason for uncertain marking');
        return false;
      }
      annotations[task.task_id] = {
        task_id: task.task_id,
        annotator_id: annotatorName + '(' + annotatorId + ')',
        label_L1: levels.L1 || '',
        label_L2: levels.L2 || '',
        label_L3: levels.L3 || '',
        label_L4: levels.L4 || '',
        label_L5: levels.L5 || '',
        label_path: path || '',
        label_path_en: pathEn || '',
        ai_action: 'UNCERTAIN',
        is_uncertain: 'true',
        uncertain_reason: reason,
        timestamp: new Date().toISOString(),
        duration_ms: Date.now() - startTime
      };
    } else {
      if (!path) {
        showToast('Please select a label path before confirming');
        return false;
      }
      const aiAction = determineAiAction(path, task.ai_path || '');
      annotations[task.task_id] = {
        task_id: task.task_id,
        annotator_id: annotatorName + '(' + annotatorId + ')',
        label_L1: levels.L1 || '',
        label_L2: levels.L2 || '',
        label_L3: levels.L3 || '',
        label_L4: levels.L4 || '',
        label_L5: levels.L5 || '',
        label_path: path,
        label_path_en: pathEn,
        ai_action: aiAction,
        is_uncertain: 'false',
        uncertain_reason: '',
        timestamp: new Date().toISOString(),
        duration_ms: Date.now() - startTime
      };
    }

    persistToLocalStorage();

    const count = Object.keys(annotations).length;
    if (count > 0 && count % 100 === 0) {
      showToast('You have labeled ' + count + ' items. Consider exporting a backup!');
    }

    return true;
  }

  function persistToLocalStorage() {
    if (!annotatorId || !batchId) return;
    const key = 'ssa_annotation_' + annotatorId + '_batch' + batchId;
    try {
      localStorage.setItem(key, JSON.stringify(annotations));
    } catch (e) {
      console.warn('localStorage write failed:', e);
    }
  }

  function loadFromLocalStorage() {
    if (!annotatorId || !batchId) return;
    const key = 'ssa_annotation_' + annotatorId + '_batch' + batchId;
    try {
      const data = localStorage.getItem(key);
      if (data) {
        annotations = JSON.parse(data);
        showToast('Restored ' + Object.keys(annotations).length + ' saved annotations');
      } else {
        annotations = {};
      }
    } catch (e) {
      annotations = {};
    }
  }

  // ========== STATS ==========
  function updateStats() {
    const total = currentTasks.length;
    const labeled = Object.keys(annotations).filter(id =>
      currentTasks.some(t => t.task_id === id)
    ).length;
    const uncertain = Object.keys(annotations).filter(id =>
      annotations[id].is_uncertain === 'true' && currentTasks.some(t => t.task_id === id)
    ).length;
    const left = total - labeled;

    document.getElementById('statsText').innerHTML =
      'Labeled: <span class="labeled">' + labeled + '</span> | ' +
      'Uncertain: <span class="uncertain">' + uncertain + '</span> | ' +
      'Left: <span class="remaining">' + left + '</span>';
  }

  function updateProgressBar() {
    const total = currentTasks.length;
    if (!total) return;
    const labeled = Object.keys(annotations).filter(id =>
      currentTasks.some(t => t.task_id === id)
    ).length;
    const pct = (labeled / total * 100).toFixed(1);
    document.getElementById('progressBarFill').style.width = pct + '%';
  }

  // ========== EXPORT ==========
  function exportCSV() {
    if (!annotatorId || !annotatorName) {
      showToast('Please log in first');
      return;
    }

    const taskAnnotations = currentTasks
      .map(t => annotations[t.task_id])
      .filter(a => a);

    if (taskAnnotations.length === 0) {
      showToast('No annotations to export');
      return;
    }

    const now = new Date();
    const ts = now.getFullYear().toString() +
      String(now.getMonth() + 1).padStart(2, '0') +
      String(now.getDate()).padStart(2, '0') + '_' +
      String(now.getHours()).padStart(2, '0') +
      String(now.getMinutes()).padStart(2, '0') +
      String(now.getSeconds()).padStart(2, '0');

    const filename = 'annotation_' + annotatorName + '_' + annotatorId + '_batch' + batchId + '_' + ts + '.csv';

    const header = 'task_id,annotator_id,label_L1,label_L2,label_L3,label_L4,label_L5,label_path,label_path_en,ai_action,is_uncertain,uncertain_reason,timestamp,duration_ms';
    const rows = taskAnnotations.map(a => {
      return [
        csvEscape(a.task_id),
        csvEscape(a.annotator_id),
        csvEscape(a.label_L1),
        csvEscape(a.label_L2),
        csvEscape(a.label_L3),
        csvEscape(a.label_L4),
        csvEscape(a.label_L5),
        csvEscape(a.label_path),
        csvEscape(a.label_path_en),
        csvEscape(a.ai_action),
        csvEscape(a.is_uncertain),
        csvEscape(a.uncertain_reason),
        csvEscape(a.timestamp),
        a.duration_ms || 0
      ].join(',');
    });

    const bom = '\ufeff';
    const content = bom + header + '\n' + rows.join('\n') + '\n';

    const blob = new Blob([content], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showToast('Exported ' + taskAnnotations.length + ' annotations: ' + filename);
  }

  function csvEscape(val) {
    if (val == null) return '';
    val = String(val);
    if (val.includes(',') || val.includes('"') || val.includes('\n')) {
      return '"' + val.replace(/"/g, '""') + '"';
    }
    return val;
  }

  // ========== TOAST ==========
  function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => { toast.classList.remove('show'); }, 3000);
  }

  // ========== LOGIN MODAL ==========
  function showLoginModal() {
    document.getElementById('loginOverlay').style.display = 'flex';
    document.getElementById('loginName').value = '';
    document.getElementById('loginGroup').value = 'A';
    document.getElementById('loginStartBtn').disabled = true;
    document.getElementById('loginName').focus();
  }

  function hideLoginModal() {
    document.getElementById('loginOverlay').style.display = 'none';
  }

  function setupLoginListeners() {
    const nameInput = document.getElementById('loginName');
    const startBtn = document.getElementById('loginStartBtn');

    nameInput.addEventListener('input', function() {
      startBtn.disabled = !this.value.trim();
    });

    nameInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && this.value.trim()) {
        e.preventDefault();
        startBtn.click();
      }
    });

    startBtn.addEventListener('click', function() {
      const name = document.getElementById('loginName').value.trim();
      const group = document.getElementById('loginGroup').value;
      if (!name) return;

      annotatorName = name;
      annotatorId = group;

      // Save identity to localStorage
      try {
        localStorage.setItem('ssa_annotator_identity', JSON.stringify({ name: name, group: group }));
      } catch (e) {
        console.warn('Failed to save identity:', e);
      }

      hideLoginModal();
      updateAnnotatorDisplay();
      onIdentityReady();
    });

    document.getElementById('switchUserBtn').addEventListener('click', function() {
      try {
        localStorage.removeItem('ssa_annotator_identity');
      } catch (e) {}
      annotatorId = '';
      annotatorName = '';
      annotations = {};
      currentTasks = [];
      currentIndex = 0;
      document.getElementById('annotatorDisplay').textContent = '--';
      showLoginModal();
    });
  }

  function updateAnnotatorDisplay() {
    document.getElementById('annotatorDisplay').textContent = annotatorName + ' (' + annotatorId + ')';
  }

  function loadSavedIdentity() {
    try {
      const saved = localStorage.getItem('ssa_annotator_identity');
      if (saved) {
        const identity = JSON.parse(saved);
        if (identity.name && identity.group) {
          annotatorName = identity.name;
          annotatorId = identity.group;
          return true;
        }
      }
    } catch (e) {}
    return false;
  }

  function onIdentityReady() {
    if (dataReady && annotatorId) {
      loadFromLocalStorage();
      filterAndLoadTasks();
    }
  }

  // ========== INIT ==========
  function init() {
    const hasTaxonomy = typeof window.TREE_A !== 'undefined' && window.TREE_A;
    const hasTasks780 = typeof window.ANNOTATION_TASKS_780 !== 'undefined' && window.ANNOTATION_TASKS_780;
    const hasTasks1000 = typeof window.ANNOTATION_TASKS_1000 !== 'undefined' && window.ANNOTATION_TASKS_1000;
    const hasManifest = typeof window.ASSIGNMENT_MANIFEST !== 'undefined' && window.ASSIGNMENT_MANIFEST;

    if (hasTaxonomy) {
      taxonomyData = window.TREE_A;
      buildTreeIndex(taxonomyData);
    }
    if (hasTasks780) {
      tasks780 = parseCSV(window.ANNOTATION_TASKS_780);
    }
    if (hasTasks1000) {
      tasks1000 = parseCSV(window.ANNOTATION_TASKS_1000);
    }
    if (hasManifest) {
      manifestData = parseCSV(window.ASSIGNMENT_MANIFEST);
    }

    setupLoginListeners();
    setupEventListeners();
    setupSearch(3);
    setupSearch(4);
    setupSearch(5);

    // Check for saved identity
    const hasIdentity = loadSavedIdentity();

    if (!hasTaxonomy || (!hasTasks780 && !hasTasks1000)) {
      // Need upload fallback - but check identity first
      if (!hasIdentity) {
        // Show login modal first; on login, check data and show upload fallback if needed
        showLoginModal();
        // Override the login start to chain into upload fallback check
        const origStartClick = document.getElementById('loginStartBtn').onclick;
        // The listener is already set up - after login, onIdentityReady checks dataReady
        // We just need to also show upload fallback after login if data isn't ready
        const loginStartBtn = document.getElementById('loginStartBtn');
        // Remove existing listener and replace
        const newLoginStartBtn = loginStartBtn.cloneNode(true);
        loginStartBtn.parentNode.replaceChild(newLoginStartBtn, loginStartBtn);
        document.getElementById('loginName').addEventListener('input', function() {
          newLoginStartBtn.disabled = !this.value.trim();
        });
        newLoginStartBtn.addEventListener('click', function() {
          const name = document.getElementById('loginName').value.trim();
          const group = document.getElementById('loginGroup').value;
          if (!name) return;
          annotatorName = name;
          annotatorId = group;
          try {
            localStorage.setItem('ssa_annotator_identity', JSON.stringify({ name: name, group: group }));
          } catch (e) {}
          hideLoginModal();
          updateAnnotatorDisplay();
          showUploadFallback(hasTaxonomy, hasTasks780, hasTasks1000, hasManifest);
        });
      } else {
        updateAnnotatorDisplay();
        showUploadFallback(hasTaxonomy, hasTasks780, hasTasks1000, hasManifest);
      }
    } else {
      dataReady = true;
      populateSelect(document.getElementById('selectL1'), l1Nodes, '-- Select L1 --');
      if (!hasIdentity) {
        showLoginModal();
      } else {
        updateAnnotatorDisplay();
        onIdentityReady();
      }
    }
  }

  function showUploadFallback(hasTax, has780, has1000, hasManifest) {
    const fallback = document.getElementById('uploadFallback');
    fallback.style.display = 'flex';

    if (hasTax) {
      document.getElementById('statusTaxonomy').innerHTML = '<span class="loaded">Loaded (auto)</span>';
    }
    if (has780 || has1000) {
      document.getElementById('statusTasks').innerHTML = '<span class="loaded">Loaded (auto): ' +
        (has780 ? '780 ' : '') + (has1000 ? '1000' : '') + '</span>';
    }
    if (hasManifest) {
      document.getElementById('statusManifest').innerHTML = '<span class="loaded">Loaded (auto)</span>';
    }

    document.getElementById('uploadTaxonomy').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        try {
          const text = ev.target.result;
          // Try JSON first
          try {
            taxonomyData = JSON.parse(text);
          } catch (_) {
            // Try as JS: eval the content
            eval(text);
            if (window.TREE_A) taxonomyData = window.TREE_A;
          }
          if (taxonomyData) {
            buildTreeIndex(taxonomyData);
            document.getElementById('statusTaxonomy').innerHTML = '<span class="loaded">Loaded</span>';
            checkFallbackReady();
          }
        } catch (err) {
          document.getElementById('statusTaxonomy').innerHTML = '<span class="missing">Error: ' + err.message + '</span>';
        }
      };
      reader.readAsText(file);
    });

    document.getElementById('uploadTasks').addEventListener('change', function(e) {
      const files = e.target.files;
      let count = 0;
      for (const file of files) {
        const reader = new FileReader();
        reader.onload = function(ev) {
          const text = ev.target.result;
          const rows = parseCSV(text);
          if (file.name.includes('780')) {
            tasks780 = rows;
          } else if (file.name.includes('1000')) {
            tasks1000 = rows;
          } else {
            // Guess from content
            if (rows.length > 0 && rows[0].source === '780') {
              tasks780 = rows;
            } else {
              tasks1000 = rows;
            }
          }
          count++;
          document.getElementById('statusTasks').innerHTML = '<span class="loaded">Loaded ' + count + ' file(s): ' +
            (tasks780.length ? tasks780.length + ' (780) ' : '') +
            (tasks1000.length ? tasks1000.length + ' (1000)' : '') + '</span>';
          checkFallbackReady();
        };
        reader.readAsText(file);
      }
    });

    document.getElementById('uploadManifest').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        manifestData = parseCSV(ev.target.result);
        document.getElementById('statusManifest').innerHTML = '<span class="loaded">Loaded ' + manifestData.length + ' assignments</span>';
        checkFallbackReady();
      };
      reader.readAsText(file);
    });

    document.getElementById('startBtn').addEventListener('click', function() {
      fallback.style.display = 'none';
      dataReady = true;
      populateSelect(document.getElementById('selectL1'), l1Nodes, '-- Select L1 --');
      onIdentityReady();
    });
  }

  function checkFallbackReady() {
    const ready = taxonomyData && (tasks780.length > 0 || tasks1000.length > 0);
    document.getElementById('startBtn').disabled = !ready;
  }

  // ========== EVENT LISTENERS ==========
  function setupEventListeners() {
    // Batch select
    document.getElementById('batchSelect').addEventListener('change', function() {
      batchId = this.value;
      if (annotatorId) {
        loadFromLocalStorage();
        filterAndLoadTasks();
      }
    });

    // Level selectors
    for (let i = 1; i <= 5; i++) {
      (function(level) {
        document.getElementById('selectL' + level).addEventListener('change', function() {
          onLevelChange(level);
        });
        document.getElementById('selectL' + level).addEventListener('focus', function() {
          setActiveLevel(level);
        });
      })(i);
    }

    // Action buttons
    document.getElementById('btnAccept').addEventListener('click', doAccept);
    document.getElementById('btnModify').addEventListener('click', function() {
      // Modify just means user will adjust selectors
      showToast('Adjust the path using selectors, then Confirm');
    });
    document.getElementById('btnReselect').addEventListener('click', function() {
      resetSelectors();
      showToast('Selectors cleared. Choose a new path.');
    });
    document.getElementById('btnUncertain').addEventListener('click', doUncertain);

    // Nav buttons
    document.getElementById('btnPrev').addEventListener('click', function() { goTo(currentIndex - 1); });
    document.getElementById('btnConfirm').addEventListener('click', doConfirm);
    document.getElementById('btnExport').addEventListener('click', exportCSV);

    // Uncertain modal
    document.getElementById('uncertainReason').addEventListener('input', function() {
      document.getElementById('uncertainConfirm').disabled = !this.value.trim();
    });
    document.getElementById('uncertainCancel').addEventListener('click', function() {
      document.getElementById('uncertainModal').classList.remove('active');
    });
    document.getElementById('uncertainConfirm').addEventListener('click', function() {
      const reason = document.getElementById('uncertainReason').value.trim();
      if (!reason) return;
      currentAction = 'UNCERTAIN';
      document.getElementById('noteInput').value = reason;
      document.getElementById('uncertainModal').classList.remove('active');
      updateActionState();
      document.getElementById('btnUncertain').className = 'btn-uncertain active-uncertain';
      showToast('Marked as Uncertain');
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Don't capture if user is typing in input/textarea/select
      const tag = e.target.tagName.toLowerCase();
      if (tag === 'input' || tag === 'textarea') return;

      if (e.key === 'Enter') {
        e.preventDefault();
        doConfirm();
      } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        goTo(currentIndex - 1);
      } else if (e.key === 'ArrowRight') {
        e.preventDefault();
        goTo(currentIndex + 1);
      } else if (e.key === 'a' || e.key === 'A') {
        if (!e.ctrlKey && !e.metaKey) {
          e.preventDefault();
          doAccept();
        }
      } else if (e.key === 'u' || e.key === 'U') {
        if (!e.ctrlKey && !e.metaKey) {
          e.preventDefault();
          doUncertain();
        }
      } else if (e.key >= '1' && e.key <= '9' && !e.ctrlKey && !e.metaKey) {
        e.preventDefault();
        quickSelect(parseInt(e.key));
      }
    });
  }

  function doAccept() {
    const task = currentTasks[currentIndex];
    if (!task || !task.ai_path || task.ai_valid !== 'true') {
      showToast('No valid AI suggestion to accept');
      return;
    }
    resetSelectors();
    setSelectorsFromPath(task.ai_path);
    currentAction = 'ACCEPT';
    updateActionState();
    showToast('AI suggestion accepted');
  }

  function doUncertain() {
    document.getElementById('uncertainReason').value = document.getElementById('noteInput').value || '';
    document.getElementById('uncertainConfirm').disabled = !document.getElementById('uncertainReason').value.trim();
    document.getElementById('uncertainModal').classList.add('active');
    document.getElementById('uncertainReason').focus();
  }

  function doConfirm() {
    if (!annotatorId || !annotatorName) {
      showToast('Please log in first');
      return;
    }
    if (!currentTasks.length) return;

    if (saveAnnotation()) {
      if (currentIndex < currentTasks.length - 1) {
        loadTask(currentIndex + 1);
      } else {
        showToast('All tasks completed! Please export your results.');
      }
    }
  }

  function goTo(index) {
    if (index < 0 || index >= currentTasks.length) return;
    loadTask(index);
  }

  function quickSelect(num) {
    if (!activeLevel) return;
    const sel = document.getElementById('selectL' + activeLevel);
    if (sel.disabled) return;
    // num corresponds to 1-based option (skip the placeholder at index 0)
    if (num < sel.options.length) {
      sel.selectedIndex = num;
      onLevelChange(activeLevel);
    }
  }

  function filterAndLoadTasks() {
    const allTasks = batchId === '780' ? tasks780 : tasks1000;

    if (manifestData.length > 0 && annotatorId) {
      const assignedIds = new Set(
        manifestData
          .filter(m => m.annotator_id === annotatorId)
          .map(m => m.task_id)
      );
      currentTasks = allTasks.filter(t => assignedIds.has(t.task_id));
    } else {
      currentTasks = allTasks.slice();
    }

    if (currentTasks.length === 0) {
      showToast('No tasks found for annotator ' + annotatorId + ' in batch ' + batchId);
      document.getElementById('currentIdx').textContent = '0';
      document.getElementById('totalCount').textContent = '0';
      return;
    }

    // Find first unannotated task
    let startIdx = 0;
    for (let i = 0; i < currentTasks.length; i++) {
      if (!annotations[currentTasks[i].task_id]) {
        startIdx = i;
        break;
      }
    }

    loadTask(startIdx);
  }

  // Start
  init();
})();
</script>
</body>
</html>
